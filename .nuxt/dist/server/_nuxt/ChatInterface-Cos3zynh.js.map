{"version":3,"file":"ChatInterface-Cos3zynh.js","sources":["../../../../components/ChatInterface.vue"],"sourcesContent":["<template>\r\n  <div class=\"chat-interface\">\r\n    <div class=\"chat-header\">\r\n      <div class=\"chat-tool-info\">\r\n        <div class=\"tool-avatar\">\r\n          <img :src=\"toolIcon\" :alt=\"toolName\" />\r\n        </div>\r\n        <div class=\"tool-details\">\r\n          <h3>{{ toolName }}</h3>\r\n          <p>{{ toolDescription }}</p>\r\n        </div>\r\n      </div>\r\n      <!-- New Start Button (shown when conversationId exists) -->\r\n      <ClientOnly>\r\n        <button \r\n          v-if=\"conversationId\" \r\n          class=\"new-start-btn\" \r\n          @click=\"handleNewStart\"\r\n          title=\"Start a new conversation\"\r\n        >\r\n          New Start\r\n        </button>\r\n      </ClientOnly>\r\n    </div>\r\n    \r\n    <div class=\"chat-messages\">\r\n      <div class=\"message\" v-for=\"message in chatMessages\" :key=\"message.id\" :class=\"message.role\">\r\n        <div class=\"message-avatar\">\r\n          <img v-if=\"message.role === 'user'\" :src=\"userAvatar\" :alt=\"userName || 'User'\" />\r\n          <img v-else :src=\"toolIcon\" :alt=\"toolName\" />\r\n        </div>\r\n        <div class=\"message-content\">\r\n          <div class=\"message-text\" v-html=\"formatMessageText(message.text)\"></div>\r\n          <!-- 显示上传的文件和图片 -->\r\n          <div v-if=\"message.fileUrls && message.fileUrls.length > 0\" class=\"message-files\">\r\n            <div \r\n              v-for=\"(fileUrl, index) in message.fileUrls\" \r\n              :key=\"index\" \r\n              class=\"message-file-item\"\r\n            >\r\n              <!-- 图片直接展示 -->\r\n              <img \r\n                v-if=\"isImageFile(fileUrl)\" \r\n                :src=\"fileUrl\" \r\n                :alt=\"`Image ${index + 1}`\"\r\n                class=\"message-image\"\r\n                @click=\"openImagePreview(fileUrl)\"\r\n              />\r\n              <!-- 文档显示文档图标 -->\r\n              <a \r\n                v-else \r\n                :href=\"fileUrl\" \r\n                target=\"_blank\" \r\n                class=\"message-document\"\r\n                :title=\"getFileName(fileUrl)\"\r\n              >\r\n                <i class=\"fas fa-file\"></i>\r\n                <span class=\"document-name\">{{ getFileName(fileUrl) }}</span>\r\n              </a>\r\n            </div>\r\n          </div>\r\n          <div class=\"message-time\">{{ formatTime(message.timestamp) }}</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"chat-input\">\r\n      <div class=\"input-actions\">\r\n        <!-- Model Selection and Icons (ClientOnly to prevent hydration mismatch) -->\r\n        <ClientOnly>\r\n          <!-- Model Selection Dropdown -->\r\n          <div v-if=\"modelCategory\" class=\"model-select-wrapper\">\r\n            <select \r\n              v-model=\"selectedModel\" \r\n              class=\"model-select\"\r\n              :disabled=\"loadingModels || availableModels.length === 0\"\r\n              @change=\"onModelChange\"\r\n            >\r\n              <option value=\"\" disabled>\r\n                {{ loadingModels ? 'Loading...' : (availableModels.length === 0 ? 'No models available' : 'Select Model') }}\r\n              </option>\r\n              <option \r\n                v-for=\"model in availableModels\" \r\n                :key=\"model.id\" \r\n                :value=\"model.id\"\r\n              >\r\n                {{ model.name }}\r\n              </option>\r\n            </select>\r\n          </div>\r\n          <!-- Web Search Icon -->\r\n          <div \r\n            v-if=\"currentModelInfo && currentModelInfo.isSearch === 1\"\r\n            class=\"action-icon\" \r\n            :class=\"{ active: currentModelInfo && currentModelInfo.isSearch === 1 }\"\r\n            @click=\"toggleWebSearch\" \r\n            title=\"Web Search\"\r\n          >\r\n            <i class=\"fas fa-globe\"></i>\r\n          </div>\r\n          <!-- Thinking Icon -->\r\n          <div \r\n            v-if=\"currentModelInfo && currentModelInfo.isThink === 1\"\r\n            class=\"action-icon\" \r\n            :class=\"{ active: currentModelInfo && currentModelInfo.isThink === 1 }\"\r\n            title=\"Thinking Mode\"\r\n          >\r\n            <i class=\"fas fa-brain\"></i>\r\n          </div>\r\n          <template #fallback>\r\n            <div v-if=\"modelCategory\" class=\"model-select-wrapper\">\r\n              <select class=\"model-select\" disabled>\r\n                <option>Loading...</option>\r\n              </select>\r\n            </div>\r\n          </template>\r\n        </ClientOnly>\r\n        <!-- Upload File Button -->\r\n        <button \r\n          class=\"action-btn\" \r\n          @click=\"handleFileUpload\" \r\n          :title=\"props.modelCategory === 'DeepSeek' \r\n            ? 'Supports various types of documents, with a maximum size of 8M.' \r\n            : 'Supports images and various types of documents, with a maximum size of 8M.'\"\r\n        >\r\n          <i class=\"fas fa-paperclip\"></i>\r\n        </button>\r\n        <div class=\"uploaded-files\" v-if=\"uploadedFiles.length > 0\">\r\n          <div \r\n            class=\"file-item\" \r\n            v-for=\"(file, index) in uploadedFiles\" \r\n            :key=\"file.id\"\r\n          >\r\n            <span class=\"file-name\">{{ file.name }}</span>\r\n            <button class=\"file-delete-btn\" @click=\"removeFile(index)\" title=\"Delete File\">\r\n              <i class=\"fas fa-times\"></i>\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <div class=\"input-container\">\r\n        <textarea \r\n          v-model=\"inputMessage\" \r\n          placeholder=\"Enter your question or request...\"\r\n          @keydown.enter.prevent=\"sendMessage\"\r\n          rows=\"3\"\r\n        ></textarea>\r\n        <button class=\"send-btn\" @click=\"sendMessage\" :disabled=\"!inputMessage.trim() || isStreaming\">\r\n          <i v-if=\"!isStreaming\" class=\"fas fa-paper-plane\"></i>\r\n          <span v-else>Sending...</span>\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, nextTick, inject, computed, onMounted, watch } from 'vue'\r\nimport { useRoute } from 'vue-router'\r\nimport { useRuntimeConfig } from '#app'\r\nimport { useAuth } from '~/composables/useAuth'\r\nimport { fetchWithCache } from '~/composables/useApiCache'\r\n\r\nconst props = defineProps({\r\n  toolName: {\r\n    type: String,\r\n    required: true\r\n  },\r\n  toolDescription: {\r\n    type: String,\r\n    required: true\r\n  },\r\n  toolIcon: {\r\n    type: String,\r\n    required: true\r\n  },\r\n  modelCategory: {\r\n    type: String,\r\n    default: null\r\n  }\r\n})\r\n\r\n// 注入父组件的函数\r\nconst addToUsageHistory = inject('addToUsageHistory', null)\r\n\r\nconst config = useRuntimeConfig()\r\nconst route = useRoute()\r\nconst { token, user } = useAuth()\r\n\r\n// 计算用户头像\r\nconst userAvatar = computed(() => {\r\n  if (user.value?.avatar && user.value.avatar.trim()) {\r\n    return user.value.avatar\r\n  }\r\n  return '/default-avatar.svg'\r\n})\r\n\r\n// 计算用户名\r\nconst userName = computed(() => {\r\n  return user.value?.name && user.value.name.trim() \r\n    ? user.value.name \r\n    : 'User'\r\n})\r\n\r\n// 获取认证 token\r\nconst getAuthToken = () => {\r\n  if (!process.client) return null\r\n  try {\r\n    if (token.value) {\r\n      return token.value\r\n    }\r\n    return localStorage.getItem('auth_token')\r\n  } catch (error) {\r\n    return localStorage.getItem('auth_token')\r\n  }\r\n}\r\nconst { get } = useApi()\r\nconst { showError } = useToast()\r\n\r\nconst inputMessage = ref('')\r\nconst chatMessages = ref([])\r\nconst uploadedFiles = ref([]) // 文件对象列表\r\nconst fileUrls = ref([]) // 上传后的文件 URL 数组\r\nconst isWebSearchEnabled = ref(false)\r\nconst selectedModel = ref('')\r\nconst modelsData = ref(null)\r\nconst loadingModels = ref(false)\r\nconst conversationId = ref('')\r\nconst isStreaming = ref(false)\r\nconst chatDetailLoading = ref(false)\r\n\r\n// 仅从 URL 读取 record-id\r\nconst routeRecordId = computed(() => route.query['record-id'] || '')\r\n\r\nasync function loadChatDetailByRecordId(recordId) {\r\n  if (!recordId || !process.client) return\r\n  chatDetailLoading.value = true\r\n  try {\r\n    const url = `/api/records/chat-detail?record-id=${encodeURIComponent(recordId)}`\r\n    const authToken = getAuthToken()\r\n    const headers = { 'Content-Type': 'application/json', Accept: 'application/json' }\r\n    if (authToken) headers['Authorization'] = `Bearer ${authToken}`\r\n    const response = await fetch(url, { method: 'GET', headers, credentials: 'include' })\r\n    const raw = await response.json().catch(() => null)\r\n    if (!raw || typeof raw !== 'object') return\r\n    const errorCode = raw.errorCode ?? raw.error_code\r\n    const data = raw.data\r\n    if (errorCode !== '00000' || !data || typeof data !== 'object') return\r\n    const list = data.messageList\r\n    if (Array.isArray(list) && list.length > 0) {\r\n      chatMessages.value = list.map((item, i) => ({\r\n        id: `msg-${recordId}-${i}-${Date.now()}`,\r\n        role: item.role === 'assistant' ? 'assistant' : 'user',\r\n        text: item.message != null ? String(item.message) : '',\r\n        fileUrls: Array.isArray(item.fileUrls) ? [...item.fileUrls] : [],\r\n        timestamp: new Date()\r\n      }))\r\n    }\r\n    if (data.conversionId != null && data.conversionId !== '') {\r\n      conversationId.value = String(data.conversionId)\r\n    }\r\n    nextTick(() => scrollToBottom())\r\n  } catch (e) {\r\n    console.error('Load chat detail failed:', e)\r\n  } finally {\r\n    chatDetailLoading.value = false\r\n  }\r\n}\r\n\r\nwatch(\r\n  () => route.query['record-id'],\r\n  (recordId) => {\r\n    if (recordId) loadChatDetailByRecordId(recordId)\r\n    else {\r\n      chatMessages.value = []\r\n      conversationId.value = ''\r\n    }\r\n  },\r\n  { immediate: true }\r\n)\r\n\r\n// 计算可用的模型列表（只显示指定分类下的 CHAT 类型模型）\r\nconst availableModels = computed(() => {\r\n  if (!modelsData.value || !props.modelCategory) return []\r\n  \r\n  // 支持 categoryList (驼峰) 和 category_list (下划线) 两种格式\r\n  const categoryList = modelsData.value.categoryList || modelsData.value.category_list\r\n  \r\n  // 检查 categoryList 是否存在且为数组\r\n  if (!categoryList || !Array.isArray(categoryList)) {\r\n    console.warn('categoryList is not available or not an array:', modelsData.value)\r\n    return []\r\n  }\r\n  \r\n  const category = categoryList.find(\r\n    cat => cat && cat.name === props.modelCategory\r\n  )\r\n  \r\n  if (!category) {\r\n    console.warn('Category not found:', props.modelCategory, 'Available categories:', categoryList.map(c => c?.name))\r\n    return []\r\n  }\r\n  \r\n  // 支持 modelList (驼峰) 和 model_list (下划线) 两种格式\r\n  const modelList = category.modelList || category.model_list\r\n  \r\n  // 检查 modelList 是否存在且为数组\r\n  if (!modelList || !Array.isArray(modelList)) {\r\n    console.warn('modelList is not available or not an array for category:', category)\r\n    return []\r\n  }\r\n  \r\n  // 只返回 CHAT 类型的模型\r\n  return modelList.filter(model => model && model.type === 'CHAT')\r\n})\r\n\r\n// 获取当前选中模型的详细信息\r\nconst currentModelInfo = computed(() => {\r\n  if (!selectedModel.value || !availableModels.value.length) return null\r\n  \r\n  // 确保类型匹配（id 可能是数字或字符串）\r\n  const modelId = typeof selectedModel.value === 'string' \r\n    ? parseInt(selectedModel.value, 10) \r\n    : selectedModel.value\r\n    \r\n  return availableModels.value.find(model => {\r\n    const modelIdNum = typeof model.id === 'string' ? parseInt(model.id, 10) : model.id\r\n    return modelIdNum === modelId\r\n  }) || null\r\n})\r\n\r\n// 获取模型列表（先读本地 1 小时缓存，无有效缓存时请求 /api/common/models/tree 并写入缓存）\r\nconst fetchModels = async () => {\r\n  if (!props.modelCategory) return\r\n  if (!process.client) {\r\n    console.warn('fetchModels: Skipping on server side')\r\n    return\r\n  }\r\n  try {\r\n    loadingModels.value = true\r\n    const url = '/api/common/models/tree'\r\n    const authToken = getAuthToken()\r\n    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' }\r\n    if (authToken) headers['Authorization'] = `Bearer ${authToken}`\r\n\r\n    const result = await fetchWithCache('api_common_models_tree', async () => {\r\n      const response = await fetch(url, { method: 'GET', headers, credentials: 'include', mode: 'cors' })\r\n      if (!response.ok) {\r\n        const errorText = await response.text()\r\n        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`)\r\n      }\r\n      const data = await response.json()\r\n      const errorCode = data?.errorCode ?? data?.error_code\r\n      if (data && typeof data === 'object' && errorCode !== undefined && errorCode !== '00000') {\r\n        throw new Error(data?.userTip || data?.errorMessage || data?.error_message || 'Request failed')\r\n      }\r\n      if (data?.errorCode === '00000' && (!data?.data || typeof data?.data !== 'object')) {\r\n        throw new Error('Invalid response data structure')\r\n      }\r\n      return data\r\n    })\r\n\r\n    const errorCode = result?.errorCode ?? result?.error_code\r\n    if (result && typeof result === 'object' && errorCode !== undefined) {\r\n      if (errorCode === '00000' && result.data && typeof result.data === 'object') {\r\n        modelsData.value = result.data\r\n        console.log('Models data received:', result.data)\r\n      } else if (errorCode !== '00000') {\r\n        modelsData.value = null\r\n      }\r\n    } else if (result && typeof result === 'object') {\r\n      modelsData.value = result\r\n      console.log('Models data received (direct):', result)\r\n    } else {\r\n      modelsData.value = null\r\n    }\r\n\r\n    await nextTick()\r\n    console.log('Available models:', availableModels.value)\r\n    if (availableModels.value.length > 0) {\r\n      selectedModel.value = availableModels.value[0].id\r\n      console.log('Default model selected:', selectedModel.value)\r\n    } else {\r\n      console.warn('No available models found for category:', props.modelCategory)\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to fetch models:', error)\r\n  } finally {\r\n    loadingModels.value = false\r\n  }\r\n}\r\n\r\n// 模型选择变化处理\r\nconst onModelChange = () => {\r\n  console.log('Selected model:', selectedModel.value)\r\n  console.log('Current model info:', currentModelInfo.value)\r\n  \r\n  // 根据模型状态重置 Web Search 状态\r\n  if (currentModelInfo.value && currentModelInfo.value.isSearch === 0) {\r\n    isWebSearchEnabled.value = false\r\n  }\r\n  \r\n  // 这里可以添加其他模型切换的逻辑\r\n}\r\n\r\n// 组件挂载时获取模型列表\r\nonMounted(() => {\r\n  if (props.modelCategory) {\r\n    fetchModels()\r\n  }\r\n})\r\n\r\n// 格式化时间\r\nconst formatTime = (date) => {\r\n  if (!date) return ''\r\n  const d = new Date(date)\r\n  const hours = String(d.getHours()).padStart(2, '0')\r\n  const minutes = String(d.getMinutes()).padStart(2, '0')\r\n  return `${hours}:${minutes}`\r\n}\r\n\r\n// 判断是否为图片文件\r\nconst isImageFile = (url) => {\r\n  if (!url) return false\r\n  const lowerUrl = url.toLowerCase()\r\n  \r\n  // 检查 URL 中是否包含图片扩展名\r\n  const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.ico']\r\n  const hasImageExtension = imageExtensions.some(ext => {\r\n    // 检查扩展名是否在 URL 路径中（排除查询参数）\r\n    const urlPath = lowerUrl.split('?')[0]\r\n    return urlPath.endsWith(ext)\r\n  })\r\n  \r\n  // 检查 URL 中是否包含 image 路径（如 /image/）\r\n  const hasImagePath = lowerUrl.includes('/image/') || lowerUrl.includes('image/')\r\n  \r\n  return hasImageExtension || hasImagePath\r\n}\r\n\r\n// 获取文件名\r\nconst getFileName = (url) => {\r\n  if (!url) return 'File'\r\n  try {\r\n    const urlObj = new URL(url)\r\n    const pathname = urlObj.pathname\r\n    const fileName = pathname.split('/').pop() || 'File'\r\n    return decodeURIComponent(fileName)\r\n  } catch (e) {\r\n    // 如果不是有效的 URL，尝试从路径中提取\r\n    const parts = url.split('/')\r\n    return parts[parts.length - 1] || 'File'\r\n  }\r\n}\r\n\r\n// 打开图片预览\r\nconst openImagePreview = (imageUrl) => {\r\n  if (!process.client) return\r\n  // 在新窗口打开图片\r\n  window.open(imageUrl, '_blank')\r\n}\r\n\r\n// 格式化消息文本（支持 Markdown 风格的表格、列表等）\r\nconst formatMessageText = (text) => {\r\n  if (!text) return ''\r\n  if (!process.client) return text // 服务端渲染时直接返回原文\r\n  \r\n  // 转义 HTML 特殊字符，防止 XSS\r\n  const escapeHtml = (str) => {\r\n    const div = document.createElement('div')\r\n    div.textContent = str\r\n    return div.innerHTML\r\n  }\r\n  \r\n  // 先处理表格（在转义之前，因为需要识别原始格式）\r\n  const lines = text.split('\\n')\r\n  const processedLines = []\r\n  let i = 0\r\n  \r\n  while (i < lines.length) {\r\n    const line = lines[i].trim()\r\n    \r\n    // 检查是否是表格行\r\n    if (line.startsWith('|') && line.endsWith('|')) {\r\n      // 收集连续的表格行\r\n      const tableRows = []\r\n      let j = i\r\n      \r\n      while (j < lines.length && lines[j].trim().startsWith('|') && lines[j].trim().endsWith('|')) {\r\n        tableRows.push(lines[j].trim())\r\n        j++\r\n      }\r\n      \r\n      // 处理表格\r\n      if (tableRows.length > 0) {\r\n        let tableHtml = '<table class=\"message-table\">'\r\n        let isFirstRow = true\r\n        \r\n        tableRows.forEach((row, idx) => {\r\n          const content = row.slice(1, -1) // 移除首尾的 |\r\n          const cells = content.split('|').map(cell => cell.trim())\r\n          \r\n          // 检查是否是分隔行\r\n          const isSeparator = cells.every(cell => /^:?-+:?$/.test(cell))\r\n          if (isSeparator) {\r\n            return // 跳过分隔行\r\n          }\r\n          \r\n          const rowHtml = cells.map((cell) => {\r\n            const tag = isFirstRow ? 'th' : 'td'\r\n            const align = cell.startsWith(':') && cell.endsWith(':') ? 'center' \r\n                         : cell.endsWith(':') ? 'right' \r\n                         : 'left'\r\n            const cellContent = escapeHtml(cell.replace(/^:+/g, '').replace(/:+$/g, ''))\r\n            return `<${tag} style=\"text-align: ${align}\">${cellContent}</${tag}>`\r\n          }).join('')\r\n          \r\n          tableHtml += `<tr>${rowHtml}</tr>`\r\n          isFirstRow = false\r\n        })\r\n        \r\n        tableHtml += '</table>'\r\n        processedLines.push(tableHtml)\r\n        i = j\r\n        continue\r\n      }\r\n    }\r\n    \r\n    // 非表格行，转义后保留\r\n    processedLines.push(escapeHtml(lines[i]))\r\n    i++\r\n  }\r\n  \r\n  let formatted = processedLines.join('\\n')\r\n  \r\n  // 处理标题：### 标题\r\n  formatted = formatted.replace(/^###\\s+(.+)$/gm, '<h3 class=\"message-heading\">$1</h3>')\r\n  formatted = formatted.replace(/^##\\s+(.+)$/gm, '<h2 class=\"message-heading\">$1</h2>')\r\n  formatted = formatted.replace(/^#\\s+(.+)$/gm, '<h1 class=\"message-heading\">$1</h1>')\r\n  \r\n  // 处理无序列表：- 或 * 开头\r\n  formatted = formatted.replace(/^[\\-\\*]\\s+(.+)$/gm, '<li class=\"message-list-item\">$1</li>')\r\n  // 将连续的列表项包装在 ul 标签中\r\n  formatted = formatted.replace(/(<li[^>]*>[\\s\\S]*?<\\/li>)/g, (match) => {\r\n    if (match.includes('<ul')) return match\r\n    return `<ul class=\"message-list\">${match}</ul>`\r\n  })\r\n  \r\n  // 处理有序列表：1. 开头\r\n  formatted = formatted.replace(/^\\d+\\.\\s+(.+)$/gm, '<li class=\"message-list-item\">$1</li>')\r\n  \r\n  // 处理分隔线：---\r\n  formatted = formatted.replace(/^---+$/gm, '<hr class=\"message-divider\">')\r\n  \r\n  // 处理粗体：**文本**\r\n  formatted = formatted.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\r\n  \r\n  // 处理斜体：*文本*（避免与列表标记冲突）\r\n  formatted = formatted.replace(/(?<!\\*)\\*([^*\\n]+?)\\*(?!\\*)/g, '<em>$1</em>')\r\n  \r\n  // 处理代码块：```代码```\r\n  formatted = formatted.replace(/```([\\s\\S]*?)```/g, '<pre class=\"message-code-block\"><code>$1</code></pre>')\r\n  \r\n  // 处理行内代码：`代码`\r\n  formatted = formatted.replace(/`([^`\\n]+)`/g, '<code class=\"message-inline-code\">$1</code>')\r\n  \r\n  // 处理换行：将单个换行转换为 <br>，但保留段落之间的双换行\r\n  formatted = formatted.replace(/\\n\\n/g, '</p><p class=\"message-paragraph\">')\r\n  formatted = formatted.replace(/\\n/g, '<br>')\r\n  \r\n  // 包装在段落中（如果还没有被其他标签包装）\r\n  if (!formatted.match(/^<(table|h[1-6]|ul|ol|pre|hr)/)) {\r\n    formatted = `<p class=\"message-paragraph\">${formatted}</p>`\r\n  }\r\n  \r\n  return formatted\r\n}\r\n\r\n// 判断是否为图片文件\r\nconst isImageFileByType = (file) => {\r\n  if (!file || !file.type) return false\r\n  return file.type.startsWith('image/')\r\n}\r\n\r\n// 处理文件上传\r\nconst handleFileUpload = async () => {\r\n  const input = document.createElement('input')\r\n  input.type = 'file'\r\n  input.multiple = true\r\n  \r\n  // DeepSeek 不支持图片，只允许文档\r\n  if (props.modelCategory === 'DeepSeek') {\r\n    // 排除图片类型，只允许文档\r\n    input.accept = '.pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx,.csv,.rtf,.odt,.ods,.odp'\r\n  } else {\r\n    input.accept = '*/*'\r\n  }\r\n  \r\n  input.onchange = async (e) => {\r\n    const files = Array.from(e.target.files)\r\n    if (files.length === 0) return\r\n    \r\n    // DeepSeek 额外检查：过滤掉图片文件\r\n    if (props.modelCategory === 'DeepSeek') {\r\n      const imageFiles = files.filter(f => isImageFileByType(f))\r\n      if (imageFiles.length > 0) {\r\n        showError('DeepSeek does not support image uploads. Please upload documents only.', 5000)\r\n        // 移除图片文件，只保留文档\r\n        const documentFiles = files.filter(f => !isImageFileByType(f))\r\n        if (documentFiles.length === 0) {\r\n          return // 如果只剩下图片，直接返回\r\n        }\r\n        // 继续处理文档文件\r\n        files.length = 0\r\n        files.push(...documentFiles)\r\n      }\r\n    }\r\n    \r\n    try {\r\n      // 创建 FormData\r\n      const formData = new FormData()\r\n      files.forEach(file => {\r\n        formData.append('file', file)\r\n      })\r\n      \r\n      // 获取认证 token\r\n      const authToken = getAuthToken()\r\n      \r\n      // 构建请求头\r\n      const headers = {\r\n        'Accept': 'application/json'\r\n      }\r\n      \r\n      // 如果已登录，添加 Authorization 头\r\n      if (authToken) {\r\n        headers['Authorization'] = `Bearer ${authToken}`\r\n      }\r\n      \r\n      // 上传文件\r\n      const response = await fetch('/api/common/batch-upload', {\r\n        method: 'POST',\r\n        headers: headers,\r\n        body: formData,\r\n        credentials: 'include'\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        const errorData = await response.json().catch(() => ({}))\r\n        // 优先使用后端 errorMessage（结构：{ errorCode, errorMessage, type, data }）；代理层可能包装为 { message } 也兼容\r\n        const msg =\r\n          (errorData && typeof errorData.errorMessage === 'string' && errorData.errorMessage.trim())\r\n            ? errorData.errorMessage.trim()\r\n            : (typeof errorData?.message === 'string' && errorData.message.trim())\r\n              ? errorData.message.trim()\r\n              : (errorData?.userTip || errorData?.error || errorData?.message || 'Upload failed')\r\n        throw new Error(msg)\r\n      }\r\n      \r\n      const data = await response.json()\r\n\r\n      // 200 但业务失败（errorCode !== '00000'）也按失败处理，抛出后端 errorMessage\r\n      if (data && data.errorCode && String(data.errorCode) !== '00000') {\r\n        const msg = (typeof data.errorMessage === 'string' && data.errorMessage.trim())\r\n          ? data.errorMessage.trim()\r\n          : (data.userTip || data.message || 'Upload failed')\r\n        throw new Error(msg)\r\n      }\r\n      \r\n      // 处理统一标准响应结构：data.data.urls\r\n      let urls = []\r\n      if (data.data && data.data.urls && Array.isArray(data.data.urls)) {\r\n        urls = data.data.urls\r\n      } else if (data.fileUrls && Array.isArray(data.fileUrls)) {\r\n        urls = data.fileUrls\r\n      } else if (data.data && Array.isArray(data.data)) {\r\n        urls = data.data\r\n      }\r\n      \r\n      if (Array.isArray(urls) && urls.length > 0) {\r\n        // 保存文件 URL 到 fileUrls 数组\r\n        fileUrls.value.push(...urls)\r\n        \r\n        // 保存文件信息用于显示\r\n        files.forEach((file, index) => {\r\n          if (urls[index]) {\r\n            uploadedFiles.value.push({\r\n              id: Date.now() + Math.random(),\r\n              name: file.name,\r\n              file: file,\r\n              size: file.size,\r\n              url: urls[index] // 保存上传后的 URL\r\n            })\r\n          }\r\n        })\r\n        \r\n        console.log('Files uploaded successfully:', urls)\r\n      } else {\r\n        const msg = (data && typeof data.errorMessage === 'string' && data.errorMessage.trim())\r\n          ? data.errorMessage.trim()\r\n          : 'Invalid response: fileUrls not found'\r\n        throw new Error(msg)\r\n      }\r\n    } catch (error) {\r\n      console.error('File upload error:', error)\r\n      showError(error.message || 'Failed to upload files', 5000)\r\n      // 清空 input 的 value，否则部分浏览器再次选择同一文件不会触发 onchange，导致“无法再次上传”\r\n      if (e && e.target && e.target.type === 'file') {\r\n        e.target.value = ''\r\n      }\r\n    }\r\n  }\r\n  \r\n  input.click()\r\n}\r\n\r\n// 删除文件\r\nconst removeFile = (index) => {\r\n  // 同时删除文件 URL\r\n  if (uploadedFiles.value[index]?.url) {\r\n    const urlIndex = fileUrls.value.indexOf(uploadedFiles.value[index].url)\r\n    if (urlIndex !== -1) {\r\n      fileUrls.value.splice(urlIndex, 1)\r\n    }\r\n  }\r\n  uploadedFiles.value.splice(index, 1)\r\n}\r\n\r\n// 切换联网搜索\r\nconst toggleWebSearch = () => {\r\n  isWebSearchEnabled.value = !isWebSearchEnabled.value\r\n  console.log('Web search:', isWebSearchEnabled.value ? 'Enabled' : 'Disabled')\r\n}\r\n\r\n// 自动滚动到底部\r\nconst scrollToBottom = () => {\r\n  nextTick(() => {\r\n    const messagesContainer = document.querySelector('.chat-messages')\r\n    if (messagesContainer) {\r\n      messagesContainer.scrollTop = messagesContainer.scrollHeight\r\n    }\r\n  })\r\n}\r\n\r\nconst sendMessage = async () => {\r\n  if (!inputMessage.value.trim() || isStreaming.value) return\r\n  \r\n  // 检查是否选择了模型\r\n  if (!currentModelInfo.value) {\r\n    alert('Please select a model first')\r\n    return\r\n  }\r\n  \r\n  // 添加到使用历史\r\n  if (addToUsageHistory) {\r\n    addToUsageHistory(props.toolName)\r\n  }\r\n  \r\n  // 保存用户输入（用于错误时恢复）\r\n  const userInput = inputMessage.value\r\n  const userMessageId = Date.now()\r\n  \r\n  // 保存当前的文件 URLs（用于错误时恢复）\r\n  const currentFileUrls = [...fileUrls.value]\r\n  \r\n  // 添加用户消息，包含文件 URLs\r\n  const userMessage = {\r\n    id: userMessageId,\r\n    role: 'user',\r\n    text: userInput,\r\n    timestamp: new Date(),\r\n    fileUrls: currentFileUrls.length > 0 ? [...currentFileUrls] : undefined\r\n  }\r\n  chatMessages.value.push(userMessage)\r\n  \r\n  // 清空输入框\r\n  inputMessage.value = ''\r\n  \r\n  // 滚动到底部\r\n  scrollToBottom()\r\n  \r\n  // 创建助手消息用于流式更新\r\n  const assistantMessageId = Date.now() + 1\r\n  const assistantMessage = {\r\n    id: assistantMessageId,\r\n    role: 'assistant',\r\n    text: '',\r\n    timestamp: new Date()\r\n  }\r\n  chatMessages.value.push(assistantMessage)\r\n  \r\n  // 开始流式请求\r\n  isStreaming.value = true\r\n  \r\n  try {\r\n    await streamChatRequest(userInput, assistantMessageId, userMessageId)\r\n    // 发送成功后，清空文件 URL（因为已经提交了）\r\n    fileUrls.value = []\r\n    uploadedFiles.value = []\r\n  } catch (error) {\r\n    console.error('Stream request error:', error)\r\n    // 确保失败后能再次发起请求（发送按钮、上传等）\r\n    isStreaming.value = false\r\n    // 显示错误提示（如果流式内部已弹框，则不重复弹）\r\n    if (!error?.__handled) {\r\n      showError(error.message || 'sorry！Service is busy. Please try again later.', 5000)\r\n    }\r\n    // 清除本次会话内容：移除用户消息和助手消息\r\n    const assistantIndex = chatMessages.value.findIndex(m => m.id === assistantMessageId)\r\n    const userIndex = chatMessages.value.findIndex(m => m.id === userMessageId)\r\n    if (assistantIndex !== -1) {\r\n      chatMessages.value.splice(assistantIndex, 1)\r\n    }\r\n    if (userIndex !== -1) {\r\n      chatMessages.value.splice(userIndex, 1)\r\n    }\r\n    // 还原用户输入到文本框\r\n    inputMessage.value = userInput\r\n    // 还原文件 URLs（错误时保留文件）\r\n    fileUrls.value = currentFileUrls\r\n  } finally {\r\n    isStreaming.value = false\r\n    scrollToBottom()\r\n  }\r\n}\r\n\r\n// 流式聊天请求\r\nconst streamChatRequest = async (prompt, messageId, userMessageId) => {\r\n  if (!process.client) return\r\n  \r\n  // 获取模型名称\r\n  const modelName = currentModelInfo.value.name\r\n  \r\n  // 构建请求体\r\n  const requestBody = {\r\n    model: modelName,\r\n    prompt: prompt\r\n  }\r\n  \r\n  // 如果存在 conversationId，添加到请求中\r\n  if (conversationId.value) {\r\n    requestBody.conversationId = conversationId.value\r\n  }\r\n  \r\n  // 如果有上传的文件 URL，且当前模型是 CHAT 类型，添加到请求中\r\n  // fileUrls 字段仅应用在 Chat 类型模型上（包括 GPT、DeepSeek、Claude、Gemini 等）\r\n  if (fileUrls.value.length > 0 && currentModelInfo.value && currentModelInfo.value.type === 'CHAT') {\r\n    requestBody.fileUrls = fileUrls.value\r\n    if (process.dev) {\r\n      console.log('[Chat Stream] Adding fileUrls to request:', {\r\n        model: modelName,\r\n        category: props.modelCategory,\r\n        fileUrls: fileUrls.value,\r\n        fileCount: fileUrls.value.length\r\n      })\r\n    }\r\n  }\r\n  \r\n  // 获取认证 token\r\n  const authToken = getAuthToken()\r\n  \r\n  // 构建请求头\r\n  // 对于流式响应，Accept 头应该设置为 text/event-stream 或 application/stream+json\r\n  const headers = {\r\n    'Content-Type': 'application/json',\r\n    'Accept': 'text/event-stream, application/json, */*'\r\n  }\r\n  \r\n  // 如果已登录，添加 Authorization 头\r\n  if (authToken) {\r\n    headers['Authorization'] = `Bearer ${authToken}`\r\n  }\r\n  \r\n  // 根据模型分类选择对应的 API 接口\r\n  const getChatApiUrl = (category) => {\r\n    const apiMap = {\r\n      'GPT': '/api/chat/chatgpt',\r\n      'DeepSeek': '/api/chat/deepseek',\r\n      'Claude': '/api/chat/claude',\r\n      'Gemini': '/api/chat/gemini'\r\n    }\r\n    return apiMap[category] || '/api/chat/chatgpt' // 默认使用 chatgpt\r\n  }\r\n  \r\n  // 使用代理 API\r\n  const url = getChatApiUrl(props.modelCategory)\r\n\r\n  try {\r\n    // 发送流式请求\r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: headers,\r\n      body: JSON.stringify(requestBody),\r\n      credentials: 'include',\r\n      mode: 'cors'\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorBody = await response.json().catch(() => ({}))\r\n      const msg = errorBody?.errorMessage || errorBody?.message || `HTTP error! status: ${response.status}`\r\n      throw new Error(msg)\r\n    }\r\n\r\n    if (!response.body) {\r\n      throw new Error('Response body is empty')\r\n    }\r\n\r\n    // 读取流式响应（SSE 格式）\r\n    const reader = response.body.getReader()\r\n  const decoder = new TextDecoder()\r\n  let buffer = ''\r\n  let currentEvent = null\r\n  let currentId = null\r\n  let currentData = ''\r\n  let hasError = false // 标记是否遇到错误\r\n  let handledError = null // 记录已处理的业务错误（用于向上抛出，触发回滚）\r\n  \r\n  while (true) {\r\n    const { done, value } = await reader.read()\r\n    \r\n    if (done || hasError) {\r\n      break\r\n    }\r\n    \r\n    // 解码数据\r\n    buffer += decoder.decode(value, { stream: true })\r\n    \r\n    // 按行分割处理 SSE 格式\r\n    const lines = buffer.split('\\n')\r\n    buffer = lines.pop() || '' // 保留最后一个不完整的行\r\n    \r\n    for (const line of lines) {\r\n      const trimmedLine = line.trim()\r\n      \r\n      // 空行表示一个 SSE 消息结束\r\n      if (!trimmedLine) {\r\n        // 注意：SSE 的 event 可能缺省（缺省即 message），这里不能依赖 currentEvent 存在\r\n        if (currentData) {\r\n          try {\r\n            const eventName = currentEvent || 'message'\r\n\r\n            if (process.dev) {\r\n              // 用 log（不是 debug），避免控制台过滤导致看不到\r\n              console.log('[Chat Stream] SSE message received:', { event: eventName, id: currentId, data: currentData })\r\n            }\r\n\r\n            let data\r\n            try {\r\n              data = JSON.parse(currentData)\r\n            } catch (e) {\r\n              // 兼容：有些后端会把一段 JSON 拆成多行 data，按 SSE 规范会拼出带 \\n 的字符串，导致 JSON.parse 失败\r\n              // 尝试移除换行后再解析一次\r\n              try {\r\n                data = JSON.parse(String(currentData).replace(/\\n/g, ''))\r\n              } catch (_) {\r\n                // 有些后端会直接推纯文本；JSON 解析失败时，按纯文本处理\r\n                data = currentData\r\n              }\r\n            }\r\n\r\n            // 全局错误判断：只要 errorCode != '00000' 就弹框（内容只取 errorMessage，空则默认文案）\r\n            if (data && typeof data === 'object' && data.errorCode && String(data.errorCode) !== '00000') {\r\n              const msg =\r\n                (typeof data.errorMessage === 'string' && data.errorMessage.trim())\r\n                  ? data.errorMessage.trim()\r\n                  : 'sorry！Service is busy. Please try again later.'\r\n\r\n              // 无论是否开启 dev，都输出一条可见的日志，便于你对照 Postman 的 SSE 内容\r\n              console.warn('[Chat Stream] Non-00000 errorCode received:', {\r\n                event: eventName,\r\n                id: currentId,\r\n                raw: currentData,\r\n                parsed: data\r\n              })\r\n              // 额外输出一条纯字符串，避免控制台预览省略号影响判断\r\n              console.warn('[Chat Stream] Non-00000 raw string:', String(currentData))\r\n              showError(msg, 5000)\r\n\r\n              // 清除本次会话内容：移除用户消息和助手消息\r\n              const assistantMessageIndex = chatMessages.value.findIndex(m => m.id === messageId)\r\n              const userMessageIndex = chatMessages.value.findIndex(m => m.id === userMessageId)\r\n              if (assistantMessageIndex !== -1) {\r\n                chatMessages.value.splice(assistantMessageIndex, 1)\r\n              }\r\n              if (userMessageIndex !== -1) {\r\n                chatMessages.value.splice(userMessageIndex, 1)\r\n              }\r\n\r\n              // 还原用户输入到文本框\r\n              inputMessage.value = prompt\r\n\r\n              // 标记并停止流式\r\n              handledError = Object.assign(new Error(msg), { __handled: true })\r\n              hasError = true\r\n              isStreaming.value = false\r\n              reader.cancel().catch(() => {}) // 忽略取消时的错误\r\n              break\r\n            }\r\n\r\n            // 处理 message 事件（正常消息内容）\r\n            if (eventName === 'message') {\r\n              // 兼容多种后端字段：content / data.content / text\r\n              const content =\r\n                (data && typeof data === 'object')\r\n                  ? (data.content ?? data?.data?.content ?? data.text ?? null)\r\n                  : data\r\n\r\n              if (content !== undefined && content !== null && String(content).length > 0) {\r\n                const messageIndex = chatMessages.value.findIndex(m => m.id === messageId)\r\n                if (messageIndex !== -1) {\r\n                  // 追加内容\r\n                  chatMessages.value[messageIndex].text += String(content)\r\n                  // 实时滚动\r\n                  scrollToBottom()\r\n                }\r\n              }\r\n            }\r\n            \r\n            // 处理 complete 事件\r\n            if (eventName === 'complete') {\r\n              // 处理完成状态\r\n              if (data && typeof data === 'object' && data.status === 'completed') {\r\n                // 如果有 eventId，保存为 conversationId\r\n                if (data.eventId) {\r\n                  conversationId.value = String(data.eventId)\r\n                  console.log('Conversation ID saved:', conversationId.value)\r\n                } else if (currentId) {\r\n                  // 如果没有 eventId，使用 SSE 的 id\r\n                  conversationId.value = String(currentId)\r\n                  console.log('Conversation ID saved from SSE id:', conversationId.value)\r\n                }\r\n              }\r\n            }\r\n          } catch (parseError) {\r\n            console.warn('Failed to handle SSE message:', { event: currentEvent, id: currentId, data: currentData }, parseError)\r\n          }\r\n        }\r\n        \r\n        // 重置当前事件\r\n        currentEvent = null\r\n        currentId = null\r\n        currentData = ''\r\n        continue\r\n      }\r\n      \r\n      // 解析 SSE 字段\r\n      if (trimmedLine.startsWith('event:')) {\r\n        currentEvent = trimmedLine.substring(6).trim()\r\n      } else if (trimmedLine.startsWith('id:')) {\r\n        currentId = trimmedLine.substring(3).trim()\r\n      } else if (trimmedLine.startsWith('data:')) {\r\n        // SSE 允许同一事件多行 data，必须追加而不是覆盖\r\n        const dataLine = trimmedLine.substring(5)\r\n        currentData = currentData ? `${currentData}\\n${dataLine}` : dataLine\r\n      }\r\n    }\r\n  }\r\n  \r\n  // 处理剩余的 buffer（服务端可能不会用空行结尾，buffer 里可能包含多行：event/id/data）\r\n  if (buffer && buffer.trim()) {\r\n    const tailLines = buffer.split('\\n')\r\n    for (const rawLine of tailLines) {\r\n      const t = rawLine.trim()\r\n      if (!t) continue\r\n      if (t.startsWith('event:')) {\r\n        currentEvent = t.substring(6).trim()\r\n      } else if (t.startsWith('id:')) {\r\n        currentId = t.substring(3).trim()\r\n      } else if (t.startsWith('data:')) {\r\n        const dataLine = t.substring(5)\r\n        currentData = currentData ? `${currentData}\\n${dataLine}` : dataLine\r\n      }\r\n    }\r\n  }\r\n\r\n  // 如果最后一个 SSE 消息没有以空行结尾，这里补一次处理\r\n  if (currentData && !hasError) {\r\n    const eventName = currentEvent || 'message'\r\n    try {\r\n      if (process.dev) {\r\n        console.log('[Chat Stream] SSE final message received:', { event: eventName, id: currentId, data: currentData })\r\n      }\r\n\r\n      let data\r\n      try {\r\n        data = JSON.parse(currentData)\r\n      } catch (e) {\r\n        try {\r\n          data = JSON.parse(String(currentData).replace(/\\n/g, ''))\r\n        } catch (_) {\r\n          data = currentData\r\n        }\r\n      }\r\n\r\n      if (data && typeof data === 'object' && data.errorCode && String(data.errorCode) !== '00000') {\r\n        const msg =\r\n          (typeof data.errorMessage === 'string' && data.errorMessage.trim())\r\n            ? data.errorMessage.trim()\r\n            : 'sorry！Service is busy. Please try again later.'\r\n\r\n        console.warn('[Chat Stream] Non-00000 errorCode received (final):', {\r\n          event: eventName,\r\n          id: currentId,\r\n          raw: currentData,\r\n          parsed: data\r\n        })\r\n        console.warn('[Chat Stream] Non-00000 raw string (final):', String(currentData))\r\n        // 即使控制台被过滤，也把最后一次错误挂到 window 上，便于手动查看\r\n        if (process.client) {\r\n          window.__lastStreamError = {\r\n            at: Date.now(),\r\n            event: eventName,\r\n            id: currentId,\r\n            raw: currentData,\r\n            parsed: data\r\n          }\r\n        }\r\n        showError(msg, 5000)\r\n\r\n        const assistantMessageIndex = chatMessages.value.findIndex(m => m.id === messageId)\r\n        const userMessageIndex = chatMessages.value.findIndex(m => m.id === userMessageId)\r\n        if (assistantMessageIndex !== -1) {\r\n          chatMessages.value.splice(assistantMessageIndex, 1)\r\n        }\r\n        if (userMessageIndex !== -1) {\r\n          chatMessages.value.splice(userMessageIndex, 1)\r\n        }\r\n\r\n        inputMessage.value = prompt\r\n        handledError = Object.assign(new Error(msg), { __handled: true })\r\n        isStreaming.value = false\r\n      } else if (eventName === 'message') {\r\n        const content =\r\n          (data && typeof data === 'object')\r\n            ? (data.content ?? data?.data?.content ?? data.text ?? null)\r\n            : data\r\n\r\n        if (content !== undefined && content !== null && String(content).length > 0) {\r\n          const messageIndex = chatMessages.value.findIndex(m => m.id === messageId)\r\n          if (messageIndex !== -1) {\r\n            chatMessages.value[messageIndex].text += String(content)\r\n          }\r\n        }\r\n      } else if (eventName === 'complete' && data && typeof data === 'object' && data.status === 'completed') {\r\n        if (data.eventId) {\r\n          conversationId.value = String(data.eventId)\r\n        } else if (currentId) {\r\n          conversationId.value = String(currentId)\r\n        }\r\n      }\r\n    } catch (e) {\r\n      console.warn('Failed to handle final SSE message:', { event: eventName, id: currentId, data: currentData }, e)\r\n    }\r\n  }\r\n\r\n  // 如果流式内部已处理业务错误，向上抛出，触发 sendMessage 的回滚逻辑（避免清空 fileUrls 等）\r\n  if (handledError) {\r\n    throw handledError\r\n  }\r\n  } finally {\r\n    // 确保异常或提前退出时也能恢复发送按钮，避免“无法再发起请求”\r\n    isStreaming.value = false\r\n  }\r\n}\r\n\r\n// 处理 New Start 按钮点击\r\nconst handleNewStart = () => {\r\n  // 清空文件 URL\r\n  fileUrls.value = []\r\n  // 清除 conversationId\r\n  conversationId.value = ''\r\n  // 清除聊天消息\r\n  chatMessages.value = []\r\n  // 重新加载页面\r\n  if (process.client) {\r\n    window.location.reload()\r\n  }\r\n}\r\n\r\nconst generateAIResponse = (userInput) => {\r\n  const responses = [\r\n    'That\\'s a great question! Let me help you analyze it.',\r\n    'Based on your needs, I suggest you could consider the following aspects...',\r\n    'I understand your thoughts. Here are some suggestions for your reference.',\r\n    'This is an interesting topic! Let me explain it in detail for you.',\r\n    'Based on my knowledge, I can provide the following information...'\r\n  ]\r\n  return responses[Math.floor(Math.random() * responses.length)]\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.chat-interface {\r\n  width: 100%;\r\n  height: 100%;\r\n  background: #fff;\r\n  display: flex;\r\n  flex-direction: column;\r\n  min-height: 0;\r\n  overflow: hidden;\r\n  /* 确保能够正确计算高度 */\r\n  position: relative;\r\n}\r\n\r\n.chat-header {\r\n  padding: 16px 20px;\r\n  border-bottom: 1px solid #e2e8f0;\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  background: #f8fafc;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.new-start-btn {\r\n  padding: 8px 16px;\r\n  background: #667eea;\r\n  color: white;\r\n  border: none;\r\n  border-radius: 6px;\r\n  font-size: 0.875rem;\r\n  font-weight: 500;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n.new-start-btn:hover {\r\n  background: #5a6fd8;\r\n  transform: translateY(-1px);\r\n  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);\r\n}\r\n\r\n.chat-tool-info {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n}\r\n\r\n.tool-avatar {\r\n  width: 40px;\r\n  height: 40px;\r\n  border-radius: 8px;\r\n  overflow: hidden;\r\n}\r\n\r\n.tool-avatar img {\r\n  width: 100%;\r\n  height: 100%;\r\n  object-fit: cover;\r\n}\r\n\r\n.tool-details h3 {\r\n  margin: 0;\r\n  font-size: 16px;\r\n  font-weight: 600;\r\n  color: #1e293b;\r\n}\r\n\r\n.tool-details p {\r\n  margin: 0;\r\n  font-size: 12px;\r\n  color: #64748b;\r\n}\r\n\r\n.chat-messages {\r\n  /* 初始高度：一半高度 */\r\n  min-height: calc((1330px - 200px - 70px - 140px) / 2);\r\n  /* 最大高度：撑满剩余空间 */\r\n  max-height: calc(1330px - 200px - 70px - 140px);\r\n  /* 当内容超出最大高度时，出现滚动条 */\r\n  overflow-y: auto;\r\n  overflow-x: hidden;\r\n  padding: 16px 20px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 16px;\r\n  /* 自定义滚动条样式 */\r\n  scrollbar-width: thin;\r\n  scrollbar-color: #cbd5e1 #f1f5f9;\r\n}\r\n\r\n.chat-messages::-webkit-scrollbar {\r\n  width: 6px;\r\n}\r\n\r\n.chat-messages::-webkit-scrollbar-track {\r\n  background: #f1f5f9;\r\n  border-radius: 3px;\r\n}\r\n\r\n.chat-messages::-webkit-scrollbar-thumb {\r\n  background: #cbd5e1;\r\n  border-radius: 3px;\r\n}\r\n\r\n.chat-messages::-webkit-scrollbar-thumb:hover {\r\n  background: #94a3b8;\r\n}\r\n\r\n.chat-messages:empty {\r\n  padding-bottom: 16px;\r\n}\r\n\r\n.message {\r\n  display: flex;\r\n  gap: 12px;\r\n  align-items: flex-start;\r\n}\r\n\r\n.message.user {\r\n  flex-direction: row-reverse;\r\n}\r\n\r\n.message-avatar {\r\n  width: 32px;\r\n  height: 32px;\r\n  border-radius: 50%;\r\n  overflow: hidden;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.message-avatar img {\r\n  width: 100%;\r\n  height: 100%;\r\n  object-fit: cover;\r\n}\r\n\r\n.message-content {\r\n  max-width: 70%;\r\n  background: #f8fafc;\r\n  padding: 12px 16px;\r\n  border-radius: 12px;\r\n  border: 1px solid #e2e8f0;\r\n}\r\n\r\n.message.user .message-content {\r\n  background: #667eea;\r\n  color: white;\r\n  border-color: #667eea;\r\n}\r\n\r\n.message-text {\r\n  font-size: 14px;\r\n  line-height: 1.5;\r\n  margin-bottom: 4px;\r\n  word-wrap: break-word;\r\n  overflow-wrap: break-word;\r\n}\r\n\r\n/* Markdown 格式化样式 */\r\n.message-text :deep(.message-paragraph) {\r\n  margin: 0.5em 0;\r\n}\r\n\r\n.message-text :deep(.message-heading) {\r\n  font-weight: 600;\r\n  margin: 1em 0 0.5em 0;\r\n  line-height: 1.3;\r\n}\r\n\r\n.message-text :deep(h1.message-heading) {\r\n  font-size: 1.5em;\r\n  border-bottom: 2px solid #e2e8f0;\r\n  padding-bottom: 0.3em;\r\n}\r\n\r\n.message-text :deep(h2.message-heading) {\r\n  font-size: 1.3em;\r\n  border-bottom: 1px solid #e2e8f0;\r\n  padding-bottom: 0.3em;\r\n}\r\n\r\n.message-text :deep(h3.message-heading) {\r\n  font-size: 1.1em;\r\n}\r\n\r\n.message-text :deep(.message-table) {\r\n  width: 100%;\r\n  border-collapse: collapse;\r\n  margin: 1em 0;\r\n  font-size: 0.9em;\r\n}\r\n\r\n.message-text :deep(.message-table th),\r\n.message-text :deep(.message-table td) {\r\n  border: 1px solid #e2e8f0;\r\n  padding: 8px 12px;\r\n  text-align: left;\r\n}\r\n\r\n.message-text :deep(.message-table th) {\r\n  background-color: #f8fafc;\r\n  font-weight: 600;\r\n}\r\n\r\n.message-text :deep(.message-table tr:nth-child(even)) {\r\n  background-color: #f8fafc;\r\n}\r\n\r\n.message-text :deep(.message-table tr.table-separator) {\r\n  display: none;\r\n}\r\n\r\n.message-text :deep(.message-list) {\r\n  margin: 0.5em 0;\r\n  padding-left: 1.5em;\r\n  list-style-type: disc;\r\n}\r\n\r\n.message-text :deep(.message-list-item) {\r\n  margin: 0.25em 0;\r\n  line-height: 1.6;\r\n}\r\n\r\n.message-text :deep(.message-divider) {\r\n  border: none;\r\n  border-top: 1px solid #e2e8f0;\r\n  margin: 1em 0;\r\n}\r\n\r\n.message-text :deep(.message-code-block) {\r\n  background-color: #f1f5f9;\r\n  border: 1px solid #e2e8f0;\r\n  border-radius: 6px;\r\n  padding: 12px;\r\n  margin: 1em 0;\r\n  overflow-x: auto;\r\n  font-family: 'Courier New', monospace;\r\n  font-size: 0.9em;\r\n  line-height: 1.5;\r\n}\r\n\r\n.message-text :deep(.message-code-block code) {\r\n  background: transparent;\r\n  padding: 0;\r\n  border: none;\r\n  white-space: pre;\r\n}\r\n\r\n.message-text :deep(.message-inline-code) {\r\n  background-color: #f1f5f9;\r\n  border: 1px solid #e2e8f0;\r\n  border-radius: 4px;\r\n  padding: 2px 6px;\r\n  font-family: 'Courier New', monospace;\r\n  font-size: 0.9em;\r\n}\r\n\r\n.message-text :deep(strong) {\r\n  font-weight: 600;\r\n}\r\n\r\n.message-text :deep(em) {\r\n  font-style: italic;\r\n}\r\n\r\n/* 用户消息中的样式调整 */\r\n.message.user .message-text :deep(.message-table th) {\r\n  background-color: rgba(255, 255, 255, 0.1);\r\n}\r\n\r\n.message.user .message-text :deep(.message-table tr:nth-child(even)) {\r\n  background-color: rgba(255, 255, 255, 0.05);\r\n}\r\n\r\n.message.user .message-text :deep(.message-code-block) {\r\n  background-color: rgba(255, 255, 255, 0.1);\r\n  border-color: rgba(255, 255, 255, 0.2);\r\n}\r\n\r\n.message.user .message-text :deep(.message-inline-code) {\r\n  background-color: rgba(255, 255, 255, 0.1);\r\n  border-color: rgba(255, 255, 255, 0.2);\r\n}\r\n\r\n.message-time {\r\n  font-size: 11px;\r\n  opacity: 0.7;\r\n  margin-top: 8px;\r\n}\r\n\r\n/* 消息中的文件和图片 */\r\n.message-files {\r\n  margin-top: 8px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n}\r\n\r\n.message-file-item {\r\n  display: inline-block;\r\n}\r\n\r\n/* 消息中的图片 */\r\n.message-image {\r\n  max-width: 300px;\r\n  max-height: 300px;\r\n  border-radius: 8px;\r\n  cursor: pointer;\r\n  object-fit: cover;\r\n  border: 1px solid #e2e8f0;\r\n  transition: transform 0.2s;\r\n}\r\n\r\n.message-image:hover {\r\n  transform: scale(1.02);\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n}\r\n\r\n.message.user .message-image {\r\n  border-color: rgba(255, 255, 255, 0.3);\r\n}\r\n\r\n/* 消息中的文档 */\r\n.message-document {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  padding: 8px 12px;\r\n  background: rgba(255, 255, 255, 0.1);\r\n  border-radius: 8px;\r\n  text-decoration: none;\r\n  color: inherit;\r\n  transition: background 0.2s;\r\n  border: 1px solid rgba(255, 255, 255, 0.2);\r\n}\r\n\r\n.message.user .message-document {\r\n  background: rgba(255, 255, 255, 0.15);\r\n  color: white;\r\n}\r\n\r\n.message-document:hover {\r\n  background: rgba(255, 255, 255, 0.2);\r\n}\r\n\r\n.message.user .message-document:hover {\r\n  background: rgba(255, 255, 255, 0.25);\r\n}\r\n\r\n.message-document i {\r\n  font-size: 16px;\r\n  color: #667eea;\r\n}\r\n\r\n.message.user .message-document i {\r\n  color: white;\r\n}\r\n\r\n.message-document .document-name {\r\n  font-size: 13px;\r\n  max-width: 200px;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n  white-space: nowrap;\r\n}\r\n\r\n.chat-input {\r\n  padding: 16px 20px;\r\n  border-top: 1px solid #e2e8f0;\r\n  background: #f8fafc;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.input-actions {\r\n  display: flex;\r\n  gap: 8px;\r\n  margin-bottom: 12px;\r\n  align-items: center;\r\n}\r\n\r\n.action-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  padding: 0;\r\n  background: white;\r\n  border: 1px solid #e2e8f0;\r\n  border-radius: 6px;\r\n  color: #64748b;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n.action-btn:hover {\r\n  background: #f1f5f9;\r\n  border-color: #cbd5e1;\r\n  color: #334155;\r\n}\r\n\r\n.action-btn.active {\r\n  background: #667eea;\r\n  border-color: #667eea;\r\n  color: white;\r\n}\r\n\r\n.action-btn.active:hover {\r\n  background: #5a6fd8;\r\n  border-color: #5a6fd8;\r\n}\r\n\r\n.action-btn i {\r\n  font-size: 16px;\r\n}\r\n\r\n.action-icon {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  padding: 0;\r\n  background: transparent;\r\n  border: none;\r\n  color: #64748b;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n  border-radius: 6px;\r\n}\r\n\r\n.action-icon:hover {\r\n  background: #f1f5f9;\r\n  color: #334155;\r\n}\r\n\r\n.action-icon.active {\r\n  color: #667eea;\r\n}\r\n\r\n.action-icon.active:hover {\r\n  background: #f1f5f9;\r\n  color: #5a6fd8;\r\n}\r\n\r\n.action-icon i {\r\n  font-size: 18px;\r\n}\r\n\r\n.model-select-wrapper {\r\n  position: relative;\r\n}\r\n\r\n.model-select {\r\n  min-width: 180px;\r\n  height: 36px;\r\n  padding: 0 12px;\r\n  background: white;\r\n  border: 1px solid #e2e8f0;\r\n  border-radius: 6px;\r\n  font-size: 14px;\r\n  color: #334155;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n  outline: none;\r\n  appearance: none;\r\n  background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 9L1 4h10z'/%3E%3C/svg%3E\");\r\n  background-repeat: no-repeat;\r\n  background-position: right 12px center;\r\n  padding-right: 36px;\r\n}\r\n\r\n.model-select:hover {\r\n  border-color: #cbd5e1;\r\n  background-color: #f8fafc;\r\n}\r\n\r\n.model-select:focus {\r\n  border-color: #667eea;\r\n  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\r\n}\r\n\r\n.model-select:disabled {\r\n  background-color: #f1f5f9;\r\n  color: #94a3b8;\r\n  cursor: not-allowed;\r\n}\r\n\r\n.uploaded-files {\r\n  display: flex;\r\n  gap: 8px;\r\n  align-items: center;\r\n  flex-wrap: wrap;\r\n  margin-left: 4px;\r\n}\r\n\r\n.file-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  padding: 6px 10px;\r\n  background: white;\r\n  border: 1px solid #e2e8f0;\r\n  border-radius: 6px;\r\n  font-size: 13px;\r\n  color: #334155;\r\n}\r\n\r\n.file-name {\r\n  max-width: 150px;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n  white-space: nowrap;\r\n}\r\n\r\n.file-delete-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 18px;\r\n  height: 18px;\r\n  padding: 0;\r\n  background: transparent;\r\n  border: none;\r\n  color: #94a3b8;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n  border-radius: 3px;\r\n}\r\n\r\n.file-delete-btn:hover {\r\n  background: #fee2e2;\r\n  color: #ef4444;\r\n}\r\n\r\n.file-delete-btn i {\r\n  font-size: 11px;\r\n}\r\n\r\n.input-container {\r\n  display: flex;\r\n  gap: 12px;\r\n  align-items: flex-end;\r\n}\r\n\r\n.input-container textarea {\r\n  flex: 1;\r\n  padding: 12px 16px;\r\n  border: 1px solid #e2e8f0;\r\n  border-radius: 8px;\r\n  font-size: 14px;\r\n  resize: none;\r\n  outline: none;\r\n  transition: border-color 0.2s ease;\r\n  font-family: inherit;\r\n}\r\n\r\n.input-container textarea:focus {\r\n  border-color: #667eea;\r\n}\r\n\r\n.send-btn {\r\n  width: 40px;\r\n  height: 40px;\r\n  border: none;\r\n  background: #667eea;\r\n  color: white;\r\n  border-radius: 8px;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.send-btn:hover:not(:disabled) {\r\n  background: #5a6fd8;\r\n  transform: translateY(-1px);\r\n}\r\n\r\n.send-btn:disabled {\r\n  background: #cbd5e1;\r\n  cursor: not-allowed;\r\n  transform: none;\r\n}\r\n</style>\r\n\r\n"],"names":["_ssrRenderAttrs","_mergeProps","_ssrRenderAttr","_ssrRenderList","_ssrRenderClass","_ssrInterpolate","_push","_parent","_createBlock","_createVNode"],"mappings":"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"}