{"file":"useAuth-ComhLj5o.js","mappings":";AASA,MAAM,aAAa,IAAI,IAAI;AAC3B,MAAM,cAAc,IAAI,IAAI;AAErB,MAAM,UAAU,MAAM;AAC3B,QAAM,OAAO;AACb,QAAM,QAAQ;AAGd,QAAM,YAAY,MAAM;AACtB,SAAK,QAAQ;AACb,UAAM,QAAQ;AAAA,EAKhB;AA2BA,QAAM,iBAAiB,CAAC,aAAa;AACnC,QAAI;AACF,YAAM,UAAU,KAAK,MAAM,KAAK,SAAS,MAAM,GAAG,EAAE,CAAC,CAAC,CAAC;AACvD,YAAM,MAAM,QAAQ;AACpB,UAAI,CAAC,IAAK,QAAO;AAGjB,YAAM,iBAAiB,MAAM;AAC7B,YAAM,YAAY,KAAK,IAAA,KAAS;AAChC,aAAO;AAAA,IACT,SAAS,GAAG;AACV,aAAO;AAAA,IACT;AAAA,EACF;AAGA,QAAM,WAAW,CAAC,aAAa;AAC7B,QAAI;AACF,YAAM,YAAY,SAAS,MAAM,GAAG,EAAE,CAAC;AACvC,YAAM,SAAS,UAAU,QAAQ,MAAM,GAAG,EAAE,QAAQ,MAAM,GAAG;AAC7D,YAAM,cAAc;AAAA,QAClB,KAAK,MAAM,EACR,MAAM,EAAE,EACR,IAAI,CAAC,MAAM,OAAO,OAAO,EAAE,WAAW,CAAC,EAAE,SAAS,EAAE,GAAG,MAAM,EAAE,CAAC,EAChE,KAAK,EAAE;AAAA,MAAA;AAEZ,aAAO,KAAK,MAAM,WAAW;AAAA,IAC/B,SAAS,GAAG;AACV,cAAQ,MAAM,wBAAwB,CAAC;AACvC,aAAO;AAAA,IACT;AAAA,EACF;AAGA,QAAM,QAAQ,CAAC,aAAa;AAC1B,QAAI,CAAC,SAAU,QAAO;AAGtB,QAAI,eAAe,QAAQ,GAAG;AAC5B,cAAQ,MAAM,kBAAkB;AAChC,aAAO;AAAA,IACT;AAGA,UAAM,UAAU,SAAS,QAAQ;AACjC,QAAI,CAAC,SAAS;AACZ,cAAQ,MAAM,uBAAuB;AACrC,aAAO;AAAA,IACT;AAGA,UAAM,QAAQ;AACd,SAAK,QAAQ;AAAA,MACX,MAAM,QAAQ,QAAQ;AAAA,MACtB,QAAQ,QAAQ,UAAU;AAAA,MAC1B,OAAO,QAAQ,SAAS;AAAA,MACxB,KAAK,QAAQ,OAAO;AAAA,IAAA;AAmBtB,WAAO;AAAA,EACT;AAGA,QAAM,SAAS,MAAM;AACnB,cAAA;AAAA,EACF;AAGA,QAAM,kBAAkB,SAAS,MAAM;AACrC,QAAI,CAAC,KAAK,SAAS,CAAC,MAAM,MAAO,QAAO;AACxC,QAAI;AACF,aAAO,CAAC,eAAe,MAAM,KAAK;AAAA,IACpC,SAAS,GAAG;AACV,aAAO;AAAA,IACT;AAAA,EACF,CAAC;AAOD,SAAO;AAAA,IACL,MAAM,SAAS,IAAI;AAAA,IACnB,OAAO,SAAS,KAAK;AAAA,IACrB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAEJ;","names":[],"sources":["../../../../composables/useAuth.js"],"sourcesContent":["/**\r\n * 用户认证状态管理（单例模式）\r\n * \r\n * Token 过期时间：30 天\r\n * - Token 由后端生成，过期时间由后端 JWT 的 exp 字段决定\r\n * - 前端会检查 token 是否过期，过期后自动清除\r\n * - Token 保存在 localStorage 中，保留 30 天\r\n */\r\n// 全局状态，确保所有组件共享同一个状态\r\nconst globalUser = ref(null)\r\nconst globalToken = ref(null)\r\n\r\nexport const useAuth = () => {\r\n  const user = globalUser\r\n  const token = globalToken\r\n\r\n  // 清空认证状态（内部辅助函数）\r\n  const clearAuth = () => {\r\n    user.value = null\r\n    token.value = null\r\n    if (process.client) {\r\n      localStorage.removeItem('auth_token')\r\n      localStorage.removeItem('auth_user')\r\n    }\r\n  }\r\n\r\n  // 从 localStorage 恢复用户信息\r\n  const initAuth = () => {\r\n    if (process.client) {\r\n      const savedToken = localStorage.getItem('auth_token')\r\n      const savedUser = localStorage.getItem('auth_user')\r\n      \r\n      if (savedToken && savedUser) {\r\n        try {\r\n          token.value = savedToken\r\n          user.value = JSON.parse(savedUser)\r\n          \r\n          // 检查 token 是否过期\r\n          if (isTokenExpired(savedToken)) {\r\n            clearAuth()\r\n          }\r\n        } catch (e) {\r\n          console.error('Failed to restore auth state:', e)\r\n          clearAuth()\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // 检查 token 是否过期\r\n  // Token 过期时间：30 天（由后端 JWT 的 exp 字段决定）\r\n  const isTokenExpired = (jwtToken) => {\r\n    try {\r\n      const payload = JSON.parse(atob(jwtToken.split('.')[1]))\r\n      const exp = payload.exp\r\n      if (!exp) return false\r\n      \r\n      // exp 是秒级时间戳，需要转换为毫秒\r\n      const expirationTime = exp * 1000\r\n      const isExpired = Date.now() >= expirationTime\r\n      return isExpired\r\n    } catch (e) {\r\n      return true\r\n    }\r\n  }\r\n\r\n  // 解析 JWT token\r\n  const parseJWT = (jwtToken) => {\r\n    try {\r\n      const base64Url = jwtToken.split('.')[1]\r\n      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/')\r\n      const jsonPayload = decodeURIComponent(\r\n        atob(base64)\r\n          .split('')\r\n          .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\r\n          .join('')\r\n      )\r\n      return JSON.parse(jsonPayload)\r\n    } catch (e) {\r\n      console.error('Failed to parse JWT:', e)\r\n      return null\r\n    }\r\n  }\r\n\r\n  // 登录\r\n  const login = (jwtToken) => {\r\n    if (!jwtToken) return false\r\n\r\n    // 检查 token 是否过期\r\n    if (isTokenExpired(jwtToken)) {\r\n      console.error('Token is expired')\r\n      return false\r\n    }\r\n\r\n    // 解析 token 获取用户信息\r\n    const payload = parseJWT(jwtToken)\r\n    if (!payload) {\r\n      console.error('Failed to parse token')\r\n      return false\r\n    }\r\n\r\n    // 保存 token 和用户信息\r\n    token.value = jwtToken\r\n    user.value = {\r\n      name: payload.name || '',\r\n      avatar: payload.avatar || '',\r\n      email: payload.email || '',\r\n      sub: payload.sub || ''\r\n    }\r\n\r\n    // 保存到 localStorage\r\n    // Token 保留 30 天（过期时间由后端 JWT 的 exp 字段决定）\r\n    if (process.client) {\r\n      localStorage.setItem('auth_token', jwtToken)\r\n      localStorage.setItem('auth_user', JSON.stringify(user.value))\r\n      \r\n      // 记录登录时间（可选，用于调试）\r\n      if (process.dev) {\r\n        const payload = parseJWT(jwtToken)\r\n        if (payload?.exp) {\r\n          const expirationDate = new Date(payload.exp * 1000)\r\n          console.log(`登录成功，Token 有效期至: ${expirationDate.toLocaleString('zh-CN')}`)\r\n        }\r\n      }\r\n    }\r\n\r\n    return true\r\n  }\r\n\r\n  // 登出\r\n  const logout = () => {\r\n    clearAuth()\r\n  }\r\n\r\n  // 检查是否已登录\r\n  const isAuthenticated = computed(() => {\r\n    if (!user.value || !token.value) return false\r\n    try {\r\n      return !isTokenExpired(token.value)\r\n    } catch (e) {\r\n      return false\r\n    }\r\n  })\r\n\r\n  // 初始化\r\n  if (process.client) {\r\n    initAuth()\r\n  }\r\n\r\n  return {\r\n    user: readonly(user),\r\n    token: readonly(token),\r\n    isAuthenticated,\r\n    login,\r\n    logout,\r\n    parseJWT\r\n  }\r\n}\r\n\r\n"],"version":3}