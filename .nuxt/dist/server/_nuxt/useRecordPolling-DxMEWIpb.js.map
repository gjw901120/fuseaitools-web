{"version":3,"file":"useRecordPolling-DxMEWIpb.js","sources":["../../../../composables/useRecordPolling.js"],"sourcesContent":["/**\r\n * 记录详情：单次拉取与按 status 轮询\r\n * - fetchRecordDetailOnce: 请求一次，返回 data（含 status、originalData、outputUrls）\r\n * - pollRecordByStatus: 每 10 秒请求一次，直到 status !== 1（1=进行中，2=成功，3=失败），返回 data\r\n * - pollRecordDetail: 每 10 秒请求一次，直到 outputUrls 存在（兼容旧用法）\r\n */\r\nexport function useRecordPolling() {\r\n  const POLL_INTERVAL_MS = 10 * 1000 // 10 秒\r\n\r\n  const getToken = () => {\r\n    if (!process.client) return null\r\n    try {\r\n      const { token } = useAuth()\r\n      if (token?.value) return token.value\r\n      return localStorage.getItem('auth_token')\r\n    } catch {\r\n      return localStorage.getItem('auth_token')\r\n    }\r\n  }\r\n\r\n  const requestDetail = async (recordId) => {\r\n    const url = `/api/records/detail?record-id=${encodeURIComponent(recordId)}`\r\n    const headers = { 'Content-Type': 'application/json', Accept: 'application/json' }\r\n    const token = getToken()\r\n    if (token) headers['Authorization'] = `Bearer ${token}`\r\n    const response = await fetch(url, { method: 'GET', headers, credentials: 'include' })\r\n    const raw = await response.json().catch(() => null)\r\n    if (!raw || typeof raw !== 'object') return null\r\n    const errorCode = raw.errorCode ?? raw.error_code\r\n    const data = raw.data\r\n    if (errorCode === '00000' && data && typeof data === 'object') return data\r\n    return null\r\n  }\r\n\r\n  /** 单次拉取记录详情，返回 data 或 null */\r\n  const fetchRecordDetailOnce = async (recordId) => {\r\n    if (!recordId || typeof recordId !== 'string') return null\r\n    return requestDetail(recordId)\r\n  }\r\n\r\n  /**\r\n   * 按 status 轮询：先等间隔再请求，避免与调用方已执行的 fetchRecordDetailOnce 重复（进行中时只发 1 次）\r\n   * options.getIsCancelled: () => boolean，为 true 时立即停止轮询\r\n   * @returns {Promise<Object|null>} data 或取消时 null\r\n   */\r\n  const pollRecordByStatus = async (recordId, options = {}) => {\r\n    const intervalMs = options.intervalMs ?? POLL_INTERVAL_MS\r\n    const getIsCancelled = options.getIsCancelled\r\n    if (!recordId || typeof recordId !== 'string') {\r\n      throw new Error('recordId is required')\r\n    }\r\n    for (;;) {\r\n      if (getIsCancelled?.()) return null\r\n      await new Promise(r => setTimeout(r, intervalMs))\r\n      if (getIsCancelled?.()) return null\r\n      const data = await requestDetail(recordId)\r\n      if (getIsCancelled?.()) return null\r\n      if (data != null && Number(data.status) !== 1) return data\r\n    }\r\n  }\r\n\r\n  /** 轮询直到 outputUrls 存在（兼容旧用法） */\r\n  const pollRecordDetail = async (recordId, options = {}) => {\r\n    const intervalMs = options.intervalMs ?? POLL_INTERVAL_MS\r\n    if (!recordId || typeof recordId !== 'string') {\r\n      throw new Error('recordId is required')\r\n    }\r\n    for (;;) {\r\n      const data = await requestDetail(recordId)\r\n      if (data && Array.isArray(data.outputUrls) && data.outputUrls.length > 0) return data\r\n      await new Promise(r => setTimeout(r, intervalMs))\r\n    }\r\n  }\r\n\r\n  return {\r\n    POLL_INTERVAL_MS,\r\n    fetchRecordDetailOnce,\r\n    pollRecordByStatus,\r\n    pollRecordDetail\r\n  }\r\n}\r\n"],"names":[],"mappings":";AAMO,SAAS,mBAAmB;AACjC,QAAM,mBAAmB,KAAK;AAE9B,QAAM,WAAW,MAAM;AACA,WAAO;AAAA,EAQ9B;AAEA,QAAM,gBAAgB,OAAO,aAAa;AACxC,UAAM,MAAM,iCAAiC,mBAAmB,QAAQ,CAAC;AACzE,UAAM,UAAU,EAAE,gBAAgB,oBAAoB,QAAQ,mBAAA;AAC9D,UAAM,QAAQ,SAAA;AACd,QAAI,MAAO,SAAQ,eAAe,IAAI,UAAU,KAAK;AACrD,UAAM,WAAW,MAAM,MAAM,KAAK,EAAE,QAAQ,OAAO,SAAS,aAAa,WAAW;AACpF,UAAM,MAAM,MAAM,SAAS,OAAO,MAAM,MAAM,IAAI;AAClD,QAAI,CAAC,OAAO,OAAO,QAAQ,SAAU,QAAO;AAC5C,UAAM,YAAY,IAAI,aAAa,IAAI;AACvC,UAAM,OAAO,IAAI;AACjB,QAAI,cAAc,WAAW,QAAQ,OAAO,SAAS,SAAU,QAAO;AACtE,WAAO;AAAA,EACT;AAGA,QAAM,wBAAwB,OAAO,aAAa;AAChD,QAAI,CAAC,YAAY,OAAO,aAAa,SAAU,QAAO;AACtD,WAAO,cAAc,QAAQ;AAAA,EAC/B;AAOA,QAAM,qBAAqB,OAAO,UAAU,UAAU,CAAA,MAAO;AAC3D,UAAM,aAAa,QAAQ,cAAc;AACzC,UAAM,iBAAiB,QAAQ;AAC/B,QAAI,CAAC,YAAY,OAAO,aAAa,UAAU;AAC7C,YAAM,IAAI,MAAM,sBAAsB;AAAA,IACxC;AACA,eAAS;AACP,UAAI,mDAAoB,QAAO;AAC/B,YAAM,IAAI,QAAQ,CAAA,MAAK,WAAW,GAAG,UAAU,CAAC;AAChD,UAAI,mDAAoB,QAAO;AAC/B,YAAM,OAAO,MAAM,cAAc,QAAQ;AACzC,UAAI,mDAAoB,QAAO;AAC/B,UAAI,QAAQ,QAAQ,OAAO,KAAK,MAAM,MAAM,EAAG,QAAO;AAAA,IACxD;AAAA,EACF;AAGA,QAAM,mBAAmB,OAAO,UAAU,UAAU,CAAA,MAAO;AACzD,UAAM,aAAa,QAAQ,cAAc;AACzC,QAAI,CAAC,YAAY,OAAO,aAAa,UAAU;AAC7C,YAAM,IAAI,MAAM,sBAAsB;AAAA,IACxC;AACA,eAAS;AACP,YAAM,OAAO,MAAM,cAAc,QAAQ;AACzC,UAAI,QAAQ,MAAM,QAAQ,KAAK,UAAU,KAAK,KAAK,WAAW,SAAS,EAAG,QAAO;AACjF,YAAM,IAAI,QAAQ,CAAA,MAAK,WAAW,GAAG,UAAU,CAAC;AAAA,IAClD;AAAA,EACF;AAEA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAEJ;"}