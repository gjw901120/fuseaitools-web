{"version":3,"file":"useModelPrice-BZpig2xf.js","sources":["../../../../composables/useApiCache.js","../../../../composables/useApi.js","../../../../composables/useModelPrice.js"],"sourcesContent":["/**\r\n * 本地缓存工具：用于 /api/common/models/tree、/api/common/models/price 等接口\r\n * 缓存时长 1 小时；读取时若无有效缓存则请求接口并写入缓存\r\n */\r\nconst CACHE_TTL_MS = 60 * 60 * 1000 // 1 小时\r\nconst STORAGE_PREFIX = 'api_cache_'\r\n\r\n/**\r\n * 从 localStorage 读取缓存，若不存在或已过期返回 null\r\n * @param {string} key - 缓存键（不含前缀）\r\n * @returns {*} 缓存的数据，或 null\r\n */\r\nfunction getCached(key) {\r\n  if (!process.client || typeof localStorage === 'undefined') return null\r\n  try {\r\n    const raw = localStorage.getItem(STORAGE_PREFIX + key)\r\n    if (!raw) return null\r\n    const { data, expiresAt } = JSON.parse(raw)\r\n    if (expiresAt != null && Date.now() > Number(expiresAt)) return null\r\n    return data\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * 将数据写入 localStorage，过期时间为当前时间 + CACHE_TTL_MS\r\n * @param {string} key - 缓存键（不含前缀）\r\n * @param {*} data - 要缓存的数据（会被 JSON.stringify）\r\n */\r\nfunction setCached(key, data) {\r\n  if (!process.client || typeof localStorage === 'undefined') return\r\n  try {\r\n    const expiresAt = Date.now() + CACHE_TTL_MS\r\n    localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify({ data, expiresAt }))\r\n  } catch (e) {\r\n    console.warn('ApiCache setCached failed:', e)\r\n  }\r\n}\r\n\r\n/**\r\n * 带缓存的请求：先读缓存，有效则直接返回；否则执行 fetchFn，将结果写入缓存后返回\r\n * @param {string} key - 缓存键\r\n * @param {() => Promise<*>} fetchFn - 无参异步函数，返回接口数据\r\n * @returns {Promise<*>} 接口数据（来自缓存或请求）\r\n */\r\nexport async function fetchWithCache(key, fetchFn) {\r\n  const cached = getCached(key)\r\n  if (cached !== null) return cached\r\n  const data = await fetchFn()\r\n  setCached(key, data)\r\n  return data\r\n}\r\n\r\nexport function useApiCache() {\r\n  return {\r\n    CACHE_TTL_MS,\r\n    getCached,\r\n    setCached,\r\n    fetchWithCache\r\n  }\r\n}\r\n","/**\r\n * 统一的 API 请求封装\r\n * 处理统一的响应结构：{ errorCode, errorMessage, data }\r\n * 自动在登录状态下添加认证头\r\n */\r\nexport const useApi = () => {\r\n  /**\r\n   * 获取认证 token\r\n   * @returns {string|null} 返回 token 或 null\r\n   */\r\n  const getAuthToken = () => {\r\n    if (!process.client) return null\r\n    \r\n    try {\r\n      // 优先从 useAuth 获取（如果已初始化）\r\n      const { token } = useAuth()\r\n      if (token.value) {\r\n        return token.value\r\n      }\r\n      \r\n      // 如果 useAuth 未初始化，直接从 localStorage 获取\r\n      return localStorage.getItem('auth_token')\r\n    } catch (error) {\r\n      // 如果 useAuth 不可用，直接从 localStorage 获取\r\n      return localStorage.getItem('auth_token')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 统一的 API 请求方法\r\n   * @param {string} url - 请求 URL\r\n   * @param {object} options - fetch 选项\r\n   * @returns {Promise} 返回 data 或抛出错误\r\n   */\r\n  const apiRequest = async (url, options = {}) => {\r\n    try {\r\n      // 获取认证 token\r\n      const token = getAuthToken()\r\n      \r\n      // 在客户端使用 fetch，服务端使用 $fetch\r\n      const fetchOptions = {\r\n        ...options,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Accept': 'application/json',\r\n          ...options.headers\r\n        }\r\n      }\r\n      \r\n      // 如果已登录，添加 Authorization 头\r\n      if (token) {\r\n        fetchOptions.headers['Authorization'] = `Bearer ${token}`\r\n      }\r\n      \r\n      // 如果是客户端，添加 credentials 和 mode 配置\r\n      if (process.client) {\r\n        fetchOptions.credentials = 'include'\r\n        fetchOptions.mode = 'cors'\r\n      }\r\n      \r\n      const response = await $fetch(url, fetchOptions)\r\n\r\n      // 检查响应结构\r\n      if (response && typeof response === 'object' && 'errorCode' in response) {\r\n        // 成功：errorCode === \"00000\"\r\n        if (response.errorCode === '00000') {\r\n          return response.data\r\n        } else {\r\n          // 失败：只抛出异常，由调用方 catch 后统一 showError，避免重复弹窗\r\n          const errorMessage = response.errorMessage || response.userTip || 'Request failed'\r\n          const err = new Error(errorMessage)\r\n          err.__fromApi = true\r\n          throw err\r\n        }\r\n      }\r\n\r\n      // 如果响应结构不符合预期，直接返回\r\n      return response\r\n    } catch (error) {\r\n      console.error('API request error:', error)\r\n      // 业务错误（上面 throw 的）直接抛出，由调用方 showError\r\n      if (error.__fromApi) throw error\r\n      // 网络/HTTP 错误：统一抛出带 message 的 Error，由调用方 showError\r\n      const errorMessage = error.data?.errorMessage || error.data?.userTip || error.message || 'Network error. Please try again.'\r\n      throw new Error(errorMessage)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * GET 请求\r\n   */\r\n  const get = (url, options = {}) => {\r\n    return apiRequest(url, {\r\n      method: 'GET',\r\n      ...options\r\n    })\r\n  }\r\n\r\n  /**\r\n   * POST 请求\r\n   */\r\n  const post = (url, body, options = {}) => {\r\n    return apiRequest(url, {\r\n      method: 'POST',\r\n      body,\r\n      ...options\r\n    })\r\n  }\r\n\r\n  /**\r\n   * PUT 请求\r\n   */\r\n  const put = (url, body, options = {}) => {\r\n    return apiRequest(url, {\r\n      method: 'PUT',\r\n      body,\r\n      ...options\r\n    })\r\n  }\r\n\r\n  /**\r\n   * DELETE 请求\r\n   */\r\n  const del = (url, options = {}) => {\r\n    return apiRequest(url, {\r\n      method: 'DELETE',\r\n      ...options\r\n    })\r\n  }\r\n\r\n  return {\r\n    request: apiRequest,\r\n    get,\r\n    post,\r\n    put,\r\n    delete: del\r\n  }\r\n}\r\n\r\n","/**\r\n * 根据 /api/common/models/price 返回的定价数据，按模型与表单字段计算并展示 credits\r\n * - type ONCE：直接使用 once.credits\r\n * - type RULE：用表单字段（duration, quality, size, batchSize, speed, scene）匹配 rules，取匹配规则的 credits\r\n * - 接口结果缓存到本地 1 小时，无有效缓存时再请求接口并写入缓存\r\n */\r\nimport { ref, computed } from 'vue'\r\nimport { fetchWithCache } from '~/composables/useApiCache'\r\n\r\nconst CACHE_KEY_PRICE = 'api_common_models_price'\r\nconst priceDataCache = ref(null)\r\n\r\nexport function useModelPrice() {\r\n  const { get } = useApi()\r\n\r\n  /**\r\n   * 拉取价格数据（先读本地 1 小时缓存，无有效缓存时请求接口并写入缓存）\r\n   * @returns {Promise<Object>} data 为 { [modelKey]: { type, once?, rules? } }\r\n   */\r\n  const fetchPrices = async () => {\r\n    try {\r\n      const data = await fetchWithCache(CACHE_KEY_PRICE, async () => {\r\n        const res = await get('/api/common/models/price')\r\n        return res && typeof res === 'object' ? res : null\r\n      })\r\n      priceDataCache.value = data\r\n      return priceDataCache.value\r\n    } catch (e) {\r\n      console.warn('Failed to fetch model price:', e)\r\n      return priceDataCache.value\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 根据模型 key 和可选表单字段取 credits\r\n   * @param {string} modelKey - 与接口 data 中的 key 一致，如 'nano-banana', 'sora-2-text-to-video', 'runway_generate'\r\n   * @param {Object} [formFields] - 仅 RULE 时需要，用于匹配 rules。字段与 rule 一致：duration, quality, size, batchSize, speed, scene 等\r\n   * @returns {number|null} credits 或 null\r\n   */\r\n  const getPrice = (modelKey, formFields = {}) => {\r\n    const data = priceDataCache.value\r\n    if (!data || !modelKey) return null\r\n    const item = data[modelKey]\r\n    if (!item || typeof item !== 'object') return null\r\n\r\n    if (item.type === 'ONCE' && item.once != null) {\r\n      const c = item.once.credits\r\n      return typeof c === 'number' ? c : (typeof c === 'string' ? parseFloat(c) : null)\r\n    }\r\n\r\n    if (item.type === 'RULE' && Array.isArray(item.rules) && item.rules.length > 0) {\r\n      const match = item.rules.find((rule) => {\r\n        return Object.keys(formFields).every((key) => {\r\n          const formVal = formFields[key]\r\n          if (formVal === undefined || formVal === null) return true\r\n          const ruleVal = rule[key]\r\n          return String(ruleVal) === String(formVal)\r\n        })\r\n      })\r\n      if (match && typeof match.credits === 'number') return match.credits\r\n      if (match && typeof match.credits === 'string') return parseFloat(match.credits)\r\n      if (match) return null\r\n      return null\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  /**\r\n   * 格式化 credits 用于按钮展示，如 20.0000 -> \"20\"\r\n   * @param {number|null} credits\r\n   * @returns {string}\r\n   */\r\n  const formatCredits = (credits) => {\r\n    if (credits == null || Number.isNaN(credits)) return ''\r\n    const n = Number(credits)\r\n    return n % 1 === 0 ? String(n) : n.toFixed(2)\r\n  }\r\n\r\n  return {\r\n    priceData: priceDataCache,\r\n    fetchPrices,\r\n    getPrice,\r\n    formatCredits\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}