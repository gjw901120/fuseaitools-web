import{_ as je}from"./DSLlGUtw.js";import{_ as Ae,I as Ee,E as Ne,p as Fe,k as V,r as I,z as Ue,A as De,c as p,o as v,a as d,b as fe,t as P,w as ae,l as O,F as ee,j as te,n as oe,f as pe,K as Le,v as We,h as He,s as Pe,C as ne}from"./C0Gp0dND.js";import{f as Oe}from"./BM9dyuvh.js";import{u as qe}from"./BDUmhOtL.js";const Re={class:"chat-interface"},ze={class:"chat-header"},Be={class:"chat-tool-info"},Je={class:"tool-avatar"},Ve=["src","alt"],Ge={class:"tool-details"},Ke={class:"chat-messages"},Qe={class:"message-avatar"},Xe=["src","alt"],Ye=["src","alt"],Ze={class:"message-content"},et=["innerHTML"],tt={key:0,class:"message-files"},st=["src","alt","onClick"],at=["href","title"],ot={class:"document-name"},nt={class:"message-time"},rt={class:"chat-input"},lt={class:"input-actions"},it={key:0,class:"model-select-wrapper"},ct=["disabled"],ut={value:"",disabled:""},dt=["value"],mt={key:0,class:"model-select-wrapper"},gt=["title"],ft={key:0,class:"uploaded-files"},pt={class:"file-name"},vt=["onClick"],ht={class:"input-container"},yt=["onKeydown"],wt=["disabled"],_t={key:0,class:"fas fa-paper-plane"},bt={key:1},St={__name:"ChatInterface",props:{toolName:{type:String,required:!0},toolDescription:{type:String,required:!0},toolIcon:{type:String,required:!0},modelCategory:{type:String,default:null}},setup($){const M=$,re=Ee("addToUsageHistory",null),le=Ne(),{token:ie,user:q}=Fe(),ve=V(()=>{var t;return(t=q.value)!=null&&t.avatar&&q.value.avatar.trim()?q.value.avatar:"/default-avatar.svg"}),he=V(()=>{var t;return(t=q.value)!=null&&t.name&&q.value.name.trim()?q.value.name:"User"}),G=()=>{try{return ie.value?ie.value:localStorage.getItem("auth_token")}catch{return localStorage.getItem("auth_token")}},{showError:J}=qe(),T=I(""),f=I([]),W=I([]),j=I([]),K=I(!1),A=I(""),U=I(null),Q=I(!1),b=I(""),E=I(!1),ce=I(!1);V(()=>le.query["record-id"]||"");async function ye(t){if(t){ce.value=!0;try{const s=`/api/records/chat-detail?record-id=${encodeURIComponent(t)}`,n=G(),e={"Content-Type":"application/json",Accept:"application/json"};n&&(e.Authorization=`Bearer ${n}`);const a=await(await fetch(s,{method:"GET",headers:e,credentials:"include"})).json().catch(()=>null);if(!a||typeof a!="object")return;const o=a.errorCode??a.error_code,l=a.data;if(o!=="00000"||!l||typeof l!="object")return;const m=l.messageList;Array.isArray(m)&&m.length>0&&(f.value=m.map((r,S)=>({id:`msg-${t}-${S}-${Date.now()}`,role:r.role==="assistant"?"assistant":"user",text:r.message!=null?String(r.message):"",fileUrls:Array.isArray(r.fileUrls)?[...r.fileUrls]:[],timestamp:new Date}))),l.conversionId!=null&&l.conversionId!==""&&(b.value=String(l.conversionId)),ne(()=>X())}catch(s){console.error("Load chat detail failed:",s)}finally{ce.value=!1}}}Ue(()=>le.query["record-id"],t=>{t?ye(t):(f.value=[],b.value="")},{immediate:!0});const D=V(()=>{if(!U.value||!M.modelCategory)return[];const t=U.value.categoryList||U.value.category_list;if(!t||!Array.isArray(t))return console.warn("categoryList is not available or not an array:",U.value),[];const s=t.find(e=>e&&e.name===M.modelCategory);if(!s)return console.warn("Category not found:",M.modelCategory,"Available categories:",t.map(e=>e==null?void 0:e.name)),[];const n=s.modelList||s.model_list;return!n||!Array.isArray(n)?(console.warn("modelList is not available or not an array for category:",s),[]):n.filter(e=>e&&e.type==="CHAT")}),w=V(()=>{if(!A.value||!D.value.length)return null;const t=typeof A.value=="string"?parseInt(A.value,10):A.value;return D.value.find(s=>(typeof s.id=="string"?parseInt(s.id,10):s.id)===t)||null}),we=async()=>{if(M.modelCategory)try{Q.value=!0;const t="/api/common/models/tree",s=G(),n={"Content-Type":"application/json",Accept:"application/json"};s&&(n.Authorization=`Bearer ${s}`);const e=await Oe("api_common_models_tree",async()=>{const a=await fetch(t,{method:"GET",headers:n,credentials:"include",mode:"cors"});if(!a.ok){const m=await a.text();throw new Error(`HTTP error! status: ${a.status}, message: ${m}`)}const o=await a.json(),l=(o==null?void 0:o.errorCode)??(o==null?void 0:o.error_code);if(o&&typeof o=="object"&&l!==void 0&&l!=="00000")throw new Error((o==null?void 0:o.userTip)||(o==null?void 0:o.errorMessage)||(o==null?void 0:o.error_message)||"Request failed");if((o==null?void 0:o.errorCode)==="00000"&&(!(o!=null&&o.data)||typeof(o==null?void 0:o.data)!="object"))throw new Error("Invalid response data structure");return o}),i=(e==null?void 0:e.errorCode)??(e==null?void 0:e.error_code);e&&typeof e=="object"&&i!==void 0?i==="00000"&&e.data&&typeof e.data=="object"?(U.value=e.data,console.log("Models data received:",e.data)):i!=="00000"&&(U.value=null):e&&typeof e=="object"?(U.value=e,console.log("Models data received (direct):",e)):U.value=null,await ne(),console.log("Available models:",D.value),D.value.length>0?(A.value=D.value[0].id,console.log("Default model selected:",A.value)):console.warn("No available models found for category:",M.modelCategory)}catch(t){console.error("Failed to fetch models:",t)}finally{Q.value=!1}},_e=()=>{console.log("Selected model:",A.value),console.log("Current model info:",w.value),w.value&&w.value.isSearch===0&&(K.value=!1)};De(()=>{M.modelCategory&&we()});const be=t=>{if(!t)return"";const s=new Date(t),n=String(s.getHours()).padStart(2,"0"),e=String(s.getMinutes()).padStart(2,"0");return`${n}:${e}`},Se=t=>{if(!t)return!1;const s=t.toLowerCase(),e=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".svg",".ico"].some(a=>s.split("?")[0].endsWith(a)),i=s.includes("/image/")||s.includes("image/");return e||i},ue=t=>{if(!t)return"File";try{const e=new URL(t).pathname.split("/").pop()||"File";return decodeURIComponent(e)}catch{const n=t.split("/");return n[n.length-1]||"File"}},Ce=t=>{window.open(t,"_blank")},ke=t=>{if(!t)return"";const s=o=>{const l=document.createElement("div");return l.textContent=o,l.innerHTML},n=t.split(`
`),e=[];let i=0;for(;i<n.length;){const o=n[i].trim();if(o.startsWith("|")&&o.endsWith("|")){const l=[];let m=i;for(;m<n.length&&n[m].trim().startsWith("|")&&n[m].trim().endsWith("|");)l.push(n[m].trim()),m++;if(l.length>0){let r='<table class="message-table">',S=!0;l.forEach((N,Y)=>{const F=N.slice(1,-1).split("|").map(u=>u.trim());if(F.every(u=>/^:?-+:?$/.test(u)))return;const _=F.map(u=>{const R=S?"th":"td",z=u.startsWith(":")&&u.endsWith(":")?"center":u.endsWith(":")?"right":"left",y=s(u.replace(/^:+/g,"").replace(/:+$/g,""));return`<${R} style="text-align: ${z}">${y}</${R}>`}).join("");r+=`<tr>${_}</tr>`,S=!1}),r+="</table>",e.push(r),i=m;continue}}e.push(s(n[i])),i++}let a=e.join(`
`);return a=a.replace(/^###\s+(.+)$/gm,'<h3 class="message-heading">$1</h3>'),a=a.replace(/^##\s+(.+)$/gm,'<h2 class="message-heading">$1</h2>'),a=a.replace(/^#\s+(.+)$/gm,'<h1 class="message-heading">$1</h1>'),a=a.replace(/^[\-\*]\s+(.+)$/gm,'<li class="message-list-item">$1</li>'),a=a.replace(/(<li[^>]*>[\s\S]*?<\/li>)/g,o=>o.includes("<ul")?o:`<ul class="message-list">${o}</ul>`),a=a.replace(/^\d+\.\s+(.+)$/gm,'<li class="message-list-item">$1</li>'),a=a.replace(/^---+$/gm,'<hr class="message-divider">'),a=a.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),a=a.replace(new RegExp("(?<!\\*)\\*([^*\\n]+?)\\*(?!\\*)","g"),"<em>$1</em>"),a=a.replace(/```([\s\S]*?)```/g,'<pre class="message-code-block"><code>$1</code></pre>'),a=a.replace(/`([^`\n]+)`/g,'<code class="message-inline-code">$1</code>'),a=a.replace(/\n\n/g,'</p><p class="message-paragraph">'),a=a.replace(/\n/g,"<br>"),a.match(/^<(table|h[1-6]|ul|ol|pre|hr)/)||(a=`<p class="message-paragraph">${a}</p>`),a},de=t=>!t||!t.type?!1:t.type.startsWith("image/"),Me=async()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,M.modelCategory==="DeepSeek"?t.accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx,.csv,.rtf,.odt,.ods,.odp":t.accept="*/*",t.onchange=async s=>{const n=Array.from(s.target.files);if(n.length!==0){if(M.modelCategory==="DeepSeek"&&n.filter(i=>de(i)).length>0){J("DeepSeek does not support image uploads. Please upload documents only.",5e3);const i=n.filter(a=>!de(a));if(i.length===0)return;n.length=0,n.push(...i)}try{const e=new FormData;n.forEach(r=>{e.append("file",r)});const i=G(),a={Accept:"application/json"};i&&(a.Authorization=`Bearer ${i}`);const o=await fetch("/api/common/batch-upload",{method:"POST",headers:a,body:e,credentials:"include"});if(!o.ok){const r=await o.json().catch(()=>({})),S=r&&typeof r.errorMessage=="string"&&r.errorMessage.trim()?r.errorMessage.trim():typeof(r==null?void 0:r.message)=="string"&&r.message.trim()?r.message.trim():(r==null?void 0:r.userTip)||(r==null?void 0:r.error)||(r==null?void 0:r.message)||"Upload failed";throw new Error(S)}const l=await o.json();if(l&&l.errorCode&&String(l.errorCode)!=="00000"){const r=typeof l.errorMessage=="string"&&l.errorMessage.trim()?l.errorMessage.trim():l.userTip||l.message||"Upload failed";throw new Error(r)}let m=[];if(l.data&&l.data.urls&&Array.isArray(l.data.urls)?m=l.data.urls:l.fileUrls&&Array.isArray(l.fileUrls)?m=l.fileUrls:l.data&&Array.isArray(l.data)&&(m=l.data),Array.isArray(m)&&m.length>0)j.value.push(...m),n.forEach((r,S)=>{m[S]&&W.value.push({id:Date.now()+Math.random(),name:r.name,file:r,size:r.size,url:m[S]})}),console.log("Files uploaded successfully:",m);else{const r=l&&typeof l.errorMessage=="string"&&l.errorMessage.trim()?l.errorMessage.trim():"Invalid response: fileUrls not found";throw new Error(r)}}catch(e){console.error("File upload error:",e),J(e.message||"Failed to upload files",5e3),s&&s.target&&s.target.type==="file"&&(s.target.value="")}}},t.click()},xe=t=>{var s;if((s=W.value[t])!=null&&s.url){const n=j.value.indexOf(W.value[t].url);n!==-1&&j.value.splice(n,1)}W.value.splice(t,1)},Ie=()=>{K.value=!K.value,console.log("Web search:",K.value?"Enabled":"Disabled")},X=()=>{ne(()=>{const t=document.querySelector(".chat-messages");t&&(t.scrollTop=t.scrollHeight)})},me=async()=>{if(!T.value.trim()||E.value)return;if(!w.value){alert("Please select a model first");return}re&&re(M.toolName);const t=T.value,s=Date.now(),n=[...j.value],e={id:s,role:"user",text:t,timestamp:new Date,fileUrls:n.length>0?[...n]:void 0};f.value.push(e),T.value="",X();const i=Date.now()+1,a={id:i,role:"assistant",text:"",timestamp:new Date};f.value.push(a),E.value=!0;try{await $e(t,i,s),j.value=[],W.value=[]}catch(o){console.error("Stream request error:",o),E.value=!1,o!=null&&o.__handled||J(o.message||"sorry！Service is busy. Please try again later.",5e3);const l=f.value.findIndex(r=>r.id===i),m=f.value.findIndex(r=>r.id===s);l!==-1&&f.value.splice(l,1),m!==-1&&f.value.splice(m,1),T.value=t,j.value=n}finally{E.value=!1,X()}},$e=async(t,s,n)=>{var r,S;const i={model:w.value.name,prompt:t};b.value&&(i.conversationId=b.value),j.value.length>0&&w.value&&w.value.type==="CHAT"&&(i.fileUrls=j.value);const a=G(),o={"Content-Type":"application/json",Accept:"text/event-stream, application/json, */*"};a&&(o.Authorization=`Bearer ${a}`);const m=(N=>({GPT:"/api/chat/chatgpt",DeepSeek:"/api/chat/deepseek",Claude:"/api/chat/claude",Gemini:"/api/chat/gemini"})[N]||"/api/chat/chatgpt")(M.modelCategory);try{const N=await fetch(m,{method:"POST",headers:o,body:JSON.stringify(i),credentials:"include",mode:"cors"});if(!N.ok){const y=await N.json().catch(()=>({})),c=(y==null?void 0:y.errorMessage)||(y==null?void 0:y.message)||`HTTP error! status: ${N.status}`;throw new Error(c)}if(!N.body)throw new Error("Response body is empty");const Y=N.body.getReader(),ge=new TextDecoder;let F="",H=null,_=null,u="",R=!1,z=null;for(;;){const{done:y,value:c}=await Y.read();if(y||R)break;F+=ge.decode(c,{stream:!0});const h=F.split(`
`);F=h.pop()||"";for(const x of h){const C=x.trim();if(!C){if(u)try{const k=H||"message";let g;try{g=JSON.parse(u)}catch{try{g=JSON.parse(String(u).replace(/\n/g,""))}catch{g=u}}if(g&&typeof g=="object"&&g.errorCode&&String(g.errorCode)!=="00000"){const L=typeof g.errorMessage=="string"&&g.errorMessage.trim()?g.errorMessage.trim():"sorry！Service is busy. Please try again later.";console.warn("[Chat Stream] Non-00000 errorCode received:",{event:k,id:_,raw:u,parsed:g}),console.warn("[Chat Stream] Non-00000 raw string:",String(u)),J(L,5e3);const B=f.value.findIndex(se=>se.id===s),Z=f.value.findIndex(se=>se.id===n);B!==-1&&f.value.splice(B,1),Z!==-1&&f.value.splice(Z,1),T.value=t,z=Object.assign(new Error(L),{__handled:!0}),R=!0,E.value=!1,Y.cancel().catch(()=>{});break}if(k==="message"){const L=g&&typeof g=="object"?g.content??((r=g==null?void 0:g.data)==null?void 0:r.content)??g.text??null:g;if(L!=null&&String(L).length>0){const B=f.value.findIndex(Z=>Z.id===s);B!==-1&&(f.value[B].text+=String(L),X())}}k==="complete"&&g&&typeof g=="object"&&g.status==="completed"&&(g.eventId?(b.value=String(g.eventId),console.log("Conversation ID saved:",b.value)):_&&(b.value=String(_),console.log("Conversation ID saved from SSE id:",b.value)))}catch(k){console.warn("Failed to handle SSE message:",{event:H,id:_,data:u},k)}H=null,_=null,u="";continue}if(C.startsWith("event:"))H=C.substring(6).trim();else if(C.startsWith("id:"))_=C.substring(3).trim();else if(C.startsWith("data:")){const k=C.substring(5);u=u?`${u}
${k}`:k}}}if(F&&F.trim()){const y=F.split(`
`);for(const c of y){const h=c.trim();if(h){if(h.startsWith("event:"))H=h.substring(6).trim();else if(h.startsWith("id:"))_=h.substring(3).trim();else if(h.startsWith("data:")){const x=h.substring(5);u=u?`${u}
${x}`:x}}}}if(u&&!R){const y=H||"message";try{let c;try{c=JSON.parse(u)}catch{try{c=JSON.parse(String(u).replace(/\n/g,""))}catch{c=u}}if(c&&typeof c=="object"&&c.errorCode&&String(c.errorCode)!=="00000"){const h=typeof c.errorMessage=="string"&&c.errorMessage.trim()?c.errorMessage.trim():"sorry！Service is busy. Please try again later.";console.warn("[Chat Stream] Non-00000 errorCode received (final):",{event:y,id:_,raw:u,parsed:c}),console.warn("[Chat Stream] Non-00000 raw string (final):",String(u)),window.__lastStreamError={at:Date.now(),event:y,id:_,raw:u,parsed:c},J(h,5e3);const x=f.value.findIndex(k=>k.id===s),C=f.value.findIndex(k=>k.id===n);x!==-1&&f.value.splice(x,1),C!==-1&&f.value.splice(C,1),T.value=t,z=Object.assign(new Error(h),{__handled:!0}),E.value=!1}else if(y==="message"){const h=c&&typeof c=="object"?c.content??((S=c==null?void 0:c.data)==null?void 0:S.content)??c.text??null:c;if(h!=null&&String(h).length>0){const x=f.value.findIndex(C=>C.id===s);x!==-1&&(f.value[x].text+=String(h))}}else y==="complete"&&c&&typeof c=="object"&&c.status==="completed"&&(c.eventId?b.value=String(c.eventId):_&&(b.value=String(_)))}catch(c){console.warn("Failed to handle final SSE message:",{event:y,id:_,data:u},c)}}if(z)throw z}finally{E.value=!1}},Te=()=>{j.value=[],b.value="",f.value=[],window.location.reload()};return(t,s)=>{const n=je;return v(),p("div",Re,[d("div",ze,[d("div",Be,[d("div",Je,[d("img",{src:$.toolIcon,alt:$.toolName},null,8,Ve)]),d("div",Ge,[d("h3",null,P($.toolName),1),d("p",null,P($.toolDescription),1)])]),fe(n,null,{default:ae(()=>[b.value?(v(),p("button",{key:0,class:"new-start-btn",onClick:Te,title:"Start a new conversation"}," New Start ")):O("",!0)]),_:1})]),d("div",Ke,[(v(!0),p(ee,null,te(f.value,e=>(v(),p("div",{class:oe(["message",e.role]),key:e.id},[d("div",Qe,[e.role==="user"?(v(),p("img",{key:0,src:ve.value,alt:he.value||"User"},null,8,Xe)):(v(),p("img",{key:1,src:$.toolIcon,alt:$.toolName},null,8,Ye))]),d("div",Ze,[d("div",{class:"message-text",innerHTML:ke(e.text)},null,8,et),e.fileUrls&&e.fileUrls.length>0?(v(),p("div",tt,[(v(!0),p(ee,null,te(e.fileUrls,(i,a)=>(v(),p("div",{key:a,class:"message-file-item"},[Se(i)?(v(),p("img",{key:0,src:i,alt:`Image ${a+1}`,class:"message-image",onClick:o=>Ce(i)},null,8,st)):(v(),p("a",{key:1,href:i,target:"_blank",class:"message-document",title:ue(i)},[s[2]||(s[2]=d("i",{class:"fas fa-file"},null,-1)),d("span",ot,P(ue(i)),1)],8,at))]))),128))])):O("",!0),d("div",nt,P(be(e.timestamp)),1)])],2))),128))]),d("div",rt,[d("div",lt,[fe(n,null,{fallback:ae(()=>[$.modelCategory?(v(),p("div",mt,[...s[5]||(s[5]=[d("select",{class:"model-select",disabled:""},[d("option",null,"Loading...")],-1)])])):O("",!0)]),default:ae(()=>[$.modelCategory?(v(),p("div",it,[pe(d("select",{"onUpdate:modelValue":s[0]||(s[0]=e=>A.value=e),class:"model-select",disabled:Q.value||D.value.length===0,onChange:_e},[d("option",ut,P(Q.value?"Loading...":D.value.length===0?"No models available":"Select Model"),1),(v(!0),p(ee,null,te(D.value,e=>(v(),p("option",{key:e.id,value:e.id},P(e.name),9,dt))),128))],40,ct),[[Le,A.value]])])):O("",!0),w.value&&w.value.isSearch===1?(v(),p("div",{key:1,class:oe(["action-icon",{active:w.value&&w.value.isSearch===1}]),onClick:Ie,title:"Web Search"},[...s[3]||(s[3]=[d("i",{class:"fas fa-globe"},null,-1)])],2)):O("",!0),w.value&&w.value.isThink===1?(v(),p("div",{key:2,class:oe(["action-icon",{active:w.value&&w.value.isThink===1}]),title:"Thinking Mode"},[...s[4]||(s[4]=[d("i",{class:"fas fa-brain"},null,-1)])],2)):O("",!0)]),_:1}),d("button",{class:"action-btn",onClick:Me,title:M.modelCategory==="DeepSeek"?"Supports various types of documents, with a maximum size of 8M.":"Supports images and various types of documents, with a maximum size of 8M."},[...s[6]||(s[6]=[d("i",{class:"fas fa-paperclip"},null,-1)])],8,gt),W.value.length>0?(v(),p("div",ft,[(v(!0),p(ee,null,te(W.value,(e,i)=>(v(),p("div",{class:"file-item",key:e.id},[d("span",pt,P(e.name),1),d("button",{class:"file-delete-btn",onClick:a=>xe(i),title:"Delete File"},[...s[7]||(s[7]=[d("i",{class:"fas fa-times"},null,-1)])],8,vt)]))),128))])):O("",!0)]),d("div",ht,[pe(d("textarea",{"onUpdate:modelValue":s[1]||(s[1]=e=>T.value=e),placeholder:"Enter your question or request...",onKeydown:He(Pe(me,["prevent"]),["enter"]),rows:"3"},null,40,yt),[[We,T.value]]),d("button",{class:"send-btn",onClick:me,disabled:!T.value.trim()||E.value},[E.value?(v(),p("span",bt,"Sending...")):(v(),p("i",_t))],8,wt)])])])}}},It=Ae(St,[["__scopeId","data-v-f923aa6d"]]);export{It as _};
